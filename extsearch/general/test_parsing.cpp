#include "parser.hpp"

#include <library/cpp/testing/unittest/registar.h>

Y_UNIT_TEST_SUITE(ParsingPlayerLogs) {
    Y_UNIT_TEST(TestGoodResponseFromPlayer) {
        TString messageLog = R"(clientTimestamp=1579089051971	cookie=yandexuid=964537131577617460	data={"data":{"currentStream":{"url":"https://strm.yandex.ru/vh-ott-converted/ott-content/487082342/402f0d78-07ca-2a9f-9f42-b0b6b23d2e71.ism/manifest_quality.mpd?ottsession=3da14f238f5e448598a0d5ec82651330&vsid=fd2e575bd37797b6c5d008461f823338830b854bbe06xANDx0054x1579089019&video_content_id=402f0d7807ca2a9f9f42b0b6b23d2e71"},"duration":2478.037,"isMuted":false,"time":30.068,"watchedSec":10},"documentIsVisible":true,"eventName":"Start","labels":{"appVersionCode":"3581","appVersionName":"4.8.4","from":"ru.kinopoisk","version":"54","videoType":"VOD"},"puid":"991951486","service":"AndroidPlayer","sid":"fd2e575bd37797b6c5d008461f823338830b854bbe06xANDx0054x1579089019","tags":{"event_Start":1},"timestamp":1579089051971,"version":"54","videoContentId":"402f0d7807ca2a9f9f42b0b6b23d2e71","vsid":"fd2e575bd37797b6c5d008461f823338830b854bbe06xANDx0054x1579089019"}	data_currentStream_url=https://strm.yandex.ru/vh-ott-converted/ott-content/487082342/402f0d78-07ca-2a9f-9f42-b0b6b23d2e71.ism/manifest_quality.mpd?ottsession=3da14f238f5e448598a0d5ec82651330&vsid=fd2e575bd37797b6c5d008461f823338830b854bbe06xANDx0054x1579089019&video_content_id=402f0d7807ca2a9f9f42b0b6b23d2e71	data_duration=2478.037	data_isMuted=false	data_time=30.068	data_watchedSec=10	documentIsVisible=true	eventName=Start	labels_from=ru.kinopoisk	labels_videoType=VOD	puid=991951486	serverTimestamp=1579089053204	service=AndroidPlayer	sid=fd2e575bd37797b6c5d008461f823338830b854bbe06xANDx0054x1579089019	timestamp=1579089053	userAgent=ru.yandex.video/0.4.0-RC2.62 (HUAWEI HRY-LX1; Android 9) ru.kinopoisk/4.8.4.3581	version=54	videoContentId=402f0d7807ca2a9f9f42b0b6b23d2e71	vsid=fd2e575bd37797b6c5d008461f823338830b854bbe06xANDx0054x1579089019	xForwardedFor=80.83.239.104	xRealIp=80.83.239.104	xRequestId=af6ca52b31ac7fd8	xYandexExpboxes=203836,0,82;203973,0,16	yandexuid=964537131577617460)";

        const auto& result = NPersQueue::ProcessMessageFromPlayer(messageLog);
        UNIT_ASSERT_VALUES_EQUAL(result.has_value(), true);
        UNIT_ASSERT_VALUES_EQUAL(result->first, "402f0d7807ca2a9f9f42b0b6b23d2e71");
        UNIT_ASSERT_VALUES_EQUAL(result->second, 1);
    }

    Y_UNIT_TEST(TestResponseFromPlayerWithoutDiscreteVideoContentId) {
        TString messageLog = R"(adsid=4730e4728c6c1440204497382693ace30c5beb24d3a5xWEBx2588x1579089039	clientTimestamp=1579089053758	cookie=	currentScriptSrc=https://yastatic.net/yandex-video-player-iframe-api-bundles/1.0-2588/js/video-player-iframe-api-bundle.js	data={"vsid":"35bd8e6200cdccf14f44efc9509abd18f71a0c44a73exWEBx2588x1579089039","adsid":"4730e4728c6c1440204497382693ace30c5beb24d3a5xWEBx2588x1579089039","service":"StreamPlayer","tags":{"event_Start":1},"labels":{"from":"yatvapp","version":"1.0-2588"},"timestamp":1579089053758,"eventType":"event","eventName":"Start","data":{"source":{"streams":[{"url":"https://strm.yandex.ru/vh-music-converted/content/12945653156133089822-a86f82ec-c3b4122b-6e94279c-7f77ae25/dash/manifest.mpd?clid=495&yandexuid=7019445171550916274&slots=null&from=yatvapp"},{"url":"https://strm.yandex.ru/vh-music-converted/content/12945653156133089822-a86f82ec-c3b4122b-6e94279c-7f77ae25/hls/master.m3u8?clid=495&yandexuid=7019445171550916274&slots=null&from=yatvapp"},{"url":"https://strm.yandex.ru/vh-music-converted/vod-content/12945653156133089822.m3u8?clid=495&yandexuid=7019445171550916274&slots=null&from=yatvapp"}],"adConfig":{"partnerId":0,"category":1013,"videoContentId":"44aec8f7d61405dc84912eb0ee816de7","videoContentName":"Би-2 - Компромисс","videoGenreId":[],"videoGenreName":[],"distrId":null},"withCredentials":true,"trackings":{"trackingEvents":[]},"loop":false,"shareConfig":{"link":"https://yandex.ru/efir?stream_id=44aec8f7d61405dc84912eb0ee816de7&from_block=logo_partner_player"},"preview":"","additionalParams":{"from":"yatvapp","from_block":"other","vsid":"35bd8e6200cdccf14f44efc9509abd18f71a0c44a73exWEBx2588x1579089039","adsid":"4730e4728c6c1440204497382693ace30c5beb24d3a5xWEBx2588x1579089039"},"features":{"SkippableFragments":{"skippableFragments":{},"autoSkipTimeout":5,"buttonTitles":{},"controlsShowDuration":5}},"videoInfo":{"videoContentName":"Би-2 - Компромисс","videoContentId":"44aec8f7d61405dc84912eb0ee816de7"}},"watchedSec":10,"duration":275.15999999999997,"time":9.938,"utcTime":0,"videoType":"VOD","isFullscreen":false,"currentStream":{"url":"https://strm.yandex.ru/vh-music-converted/content/12945653156133089822-a86f82ec-c3b4122b-6e94279c-7f77ae25/dash/manifest.mpd?clid=495&yandexuid=7019445171550916274&slots=null&from=yatvapp&partner-id=0&video-category-id=1013&gzip=1&from_block=other&vsid=35bd8e6200cdccf14f44efc9509abd18f71a0c44a73exWEBx2588x1579089039&adsid=4730e4728c6c1440204497382693ace30c5beb24d3a5xWEBx2588x1579089039"}},"sid":"35bd8e6200cdccf14f44efc9509abd18f71a0c44a73exWEBx2588x1579089039","version":"1.0-2588","location":"https://frontend.vh.yandex.ru/player/44aec8f7d61405dc84912eb0ee816de7?autoplay=1&mute=0&tv=1&from=yatvapp&no_ad=true&clean=true&version=1.0-2588&nativeui=true&preview=false&event_prefix=player-container__container_player%3A","topLocation":"https://frontend.vh.yandex.ru/player/44aec8f7d61405dc84912eb0ee816de7?autoplay=1&mute=0&tv=1&from=yatvapp&no_ad=true&clean=true&version=1.0-2588&nativeui=true&preview=false&event_prefix=player-container__container_player%3A","topAncestor":"file://","ancestorOrigins":["file://"],"documentIsVisible":true,"referrer":"","topReferrer":"","currentScriptSrc":"https://yastatic.net/yandex-video-player-iframe-api-bundles/1.0-2588/js/video-player-iframe-api-bundle.js","secureIFrame":true,"isVideoADB":false,"value":1,"rnd":0.13208851143591982,"routeToJSTracer":true}	data_currentStream_url=https://strm.yandex.ru/vh-music-converted/content/12945653156133089822-a86f82ec-c3b4122b-6e94279c-7f77ae25/dash/manifest.mpd?clid=495&yandexuid=7019445171550916274&slots=null&from=yatvapp&partner-id=0&video-category-id=1013&gzip=1&from_block=other&vsid=35bd8e6200cdccf14f44efc9509abd18f71a0c44a73exWEBx2588x1579089039&adsid=4730e4728c6c1440204497382693ace30c5beb24d3a5xWEBx2588x1579089039	data_duration=275.15999999999997	data_isFullscreen=false	data_source_streams_0_url=https://strm.yandex.ru/vh-music-converted/content/12945653156133089822-a86f82ec-c3b4122b-6e94279c-7f77ae25/dash/manifest.mpd?clid=495&yandexuid=7019445171550916274&slots=null&from=yatvapp	data_source_streams_1_url=https://strm.yandex.ru/vh-music-converted/content/12945653156133089822-a86f82ec-c3b4122b-6e94279c-7f77ae25/hls/master.m3u8?clid=495&yandexuid=7019445171550916274&slots=null&from=yatvapp	data_source_streams_2_url=https://strm.yandex.ru/vh-music-converted/vod-content/12945653156133089822.m3u8?clid=495&yandexuid=7019445171550916274&slots=null&from=yatvapp	data_time=9.938	data_utcTime=0	data_videoType=VOD	data_watchedSec=10	documentIsVisible=true	eventName=Start	eventType=event	labels_from=yatvapp	location=https://frontend.vh.yandex.ru/player/44aec8f7d61405dc84912eb0ee816de7?autoplay=1&mute=0&tv=1&from=yatvapp&no_ad=true&clean=true&version=1.0-2588&nativeui=true&preview=false&event_prefix=player-container__container_player%3A	referrer=	routeToJSTracer=true	secureIFrame=true	serverTimestamp=1579089053727	service=StreamPlayer	sid=35bd8e6200cdccf14f44efc9509abd18f71a0c44a73exWEBx2588x1579089039	timestamp=1579089053	topLocation=https://frontend.vh.yandex.ru/player/44aec8f7d61405dc84912eb0ee816de7?autoplay=1&mute=0&tv=1&from=yatvapp&no_ad=true&clean=true&version=1.0-2588&nativeui=true&preview=false&event_prefix=player-container__container_player%3A	topReferrer=	userAgent=Mozilla/5.0 (SMART-TV; LINUX; Tizen 4.0) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 TV Safari/537.36	version=1.0-2588	vsid=35bd8e6200cdccf14f44efc9509abd18f71a0c44a73exWEBx2588x1579089039	xForwardedFor=37.212.196.69	xRealIp=37.212.196.69	xRequestId=b5461673a7131576	xYandexExpboxes=	yandexuid=)";

        const auto& result = NPersQueue::ProcessMessageFromPlayer(messageLog);
        UNIT_ASSERT_VALUES_EQUAL(result.has_value(), true);
        UNIT_ASSERT_VALUES_EQUAL(result->first, "44aec8f7d61405dc84912eb0ee816de7");
        UNIT_ASSERT_VALUES_EQUAL(result->second, 1);
    }

    Y_UNIT_TEST(TestZenResponseFromPlayer) {
        TString messageLog = R"(clientTimestamp=1579089051971	cookie=yandexuid=964537131577617460	data={"data":{"currentStream":{"url":"https://strm.yandex.ru/vh-ott-converted/ott-content/487082342/402f0d78-07ca-2a9f-9f42-b0b6b23d2e71.ism/manifest_quality.mpd?ottsession=3da14f238f5e448598a0d5ec82651330&vsid=fd2e575bd37797b6c5d008461f823338830b854bbe06xANDx0054x1579089019&video_content_id=402f0d7807ca2a9f9f42b0b6b23d2e71"},"duration":2478.037,"isMuted":false,"time":30.068,"watchedSec":10},"documentIsVisible":true,"eventName":"Start","labels":{"appVersionCode":"3581","appVersionName":"4.8.4","from":"zen:site_desktop:yandex:site_desktop","version":"54","videoType":"VOD"},"puid":"991951486","service":"AndroidPlayer","sid":"fd2e575bd37797b6c5d008461f823338830b854bbe06xANDx0054x1579089019","tags":{"event_Start":1},"timestamp":1579089051971,"version":"54","videoContentId":"402f0d7807ca2a9f9f42b0b6b23d2e71","vsid":"fd2e575bd37797b6c5d008461f823338830b854bbe06xANDx0054x1579089019"}	data_currentStream_url=https://strm.yandex.ru/vh-ott-converted/ott-content/487082342/402f0d78-07ca-2a9f-9f42-b0b6b23d2e71.ism/manifest_quality.mpd?ottsession=3da14f238f5e448598a0d5ec82651330&vsid=fd2e575bd37797b6c5d008461f823338830b854bbe06xANDx0054x1579089019&video_content_id=402f0d7807ca2a9f9f42b0b6b23d2e71	data_duration=2478.037	data_isMuted=false	data_time=30.068	data_watchedSec=10	documentIsVisible=true	eventName=4SecWatched	labels_from=zen:site_desktop:yandex:site_desktop	labels_videoType=VOD	puid=991951486	serverTimestamp=1579089053204	service=AndroidPlayer	sid=fd2e575bd37797b6c5d008461f823338830b854bbe06xANDx0054x1579089019	timestamp=1579089053	userAgent=ru.yandex.video/0.4.0-RC2.62 (HUAWEI HRY-LX1; Android 9) ru.kinopoisk/4.8.4.3581	version=54	videoContentId=402f0d7807ca2a9f9f42b0b6b23d2e71	vsid=fd2e575bd37797b6c5d008461f823338830b854bbe06xANDx0054x1579089019	xForwardedFor=80.83.239.104	xRealIp=80.83.239.104	xRequestId=af6ca52b31ac7fd8	xYandexExpboxes=203836,0,82;203973,0,16	yandexuid=964537131577617460)";

        const auto& result = NPersQueue::ProcessMessageFromPlayer(messageLog);
        UNIT_ASSERT_VALUES_EQUAL(result.has_value(), true);
        UNIT_ASSERT_VALUES_EQUAL(result->first, "402f0d7807ca2a9f9f42b0b6b23d2e71");
        UNIT_ASSERT_VALUES_EQUAL(result->second, 1);
    }

    Y_UNIT_TEST(TestBadVideoContentID) {
    TString messageLog = R"(clientTimestamp=1579089051971	cookie=yandexuid=964537131577617460	data={"data":{"currentStream":{"url":"https://strm.yandex.ru/vh-ott-converted/ott-content/487082342/402f0d78-07ca-2a9f-9f42-b0b6b23d2e71.ism/manifest_quality.mpd?ottsession=3da14f238f5e448598a0d5ec82651330&vsid=fd2e575bd37797b6c5d008461f823338830b854bbe06xANDx0054x1579089019&video_content_id=402f0d7807ca2a9f9f42b0b6b23d2e71"},"duration":2478.037,"isMuted":false,"time":30.068,"watchedSec":10},"documentIsVisible":true,"eventName":"Start","labels":{"appVersionCode":"3581","appVersionName":"4.8.4","from":"ru.kinopoisk","version":"54","videoType":"VOD"},"puid":"991951486","service":"AndroidPlayer","sid":"fd2e575bd37797b6c5d008461f823338830b854bbe06xANDx0054x1579089019","tags":{"event_Start":1},"timestamp":1579089051971,"version":"54","videoContentId":"SOME_BAD_ID_TO_HACK$$\"DEADBEEF42","vsid":"fd2e575bd37797b6c5d008461f823338830b854bbe06xANDx0054x1579089019"}	data_currentStream_url=https://strm.yandex.ru/vh-ott-converted/ott-content/487082342/402f0d78-07ca-2a9f-9f42-b0b6b23d2e71.ism/manifest_quality.mpd?ottsession=3da14f238f5e448598a0d5ec82651330&vsid=fd2e575bd37797b6c5d008461f823338830b854bbe06xANDx0054x1579089019&video_content_id=402f0d7807ca2a9f9f42b0b6b23d2e71	data_duration=2478.037	data_isMuted=false	data_time=30.068	data_watchedSec=10	documentIsVisible=true	eventName=Start	labels_from=ru.kinopoisk	labels_videoType=VOD	puid=991951486	serverTimestamp=1579089053204	service=AndroidPlayer	sid=fd2e575bd37797b6c5d008461f823338830b854bbe06xANDx0054x1579089019	timestamp=1579089053	userAgent=ru.yandex.video/0.4.0-RC2.62 (HUAWEI HRY-LX1; Android 9) ru.kinopoisk/4.8.4.3581	version=54	videoContentId=SOME_BAD_ID_TO_HACK$$\"DEADBEEF42	vsid=fd2e575bd37797b6c5d008461f823338830b854bbe06xANDx0054x1579089019	xForwardedFor=80.83.239.104	xRealIp=80.83.239.104	xRequestId=af6ca52b31ac7fd8	xYandexExpboxes=203836,0,82;203973,0,16	yandexuid=964537131577617460)";

    const auto& result = NPersQueue::ProcessMessageFromPlayer(messageLog);
    UNIT_ASSERT_VALUES_EQUAL(result.has_value(), false);
    }


    Y_UNIT_TEST(TestUuidValidation) {
        NPersQueue::TPlayerLog playerLog("some_test_data");
        UNIT_ASSERT_VALUES_EQUAL(playerLog.IsValidUuid("v--M-_ByMrQU"), true);
        UNIT_ASSERT_VALUES_EQUAL(playerLog.IsValidUuid("48172d6679c147c6904172fac906f643"), true);
        UNIT_ASSERT_VALUES_EQUAL(playerLog.IsValidUuid("veuKoIvPwFBI"), true);
        UNIT_ASSERT_VALUES_EQUAL(playerLog.IsValidUuid("v_uKoIvPwFBI"), true);
        UNIT_ASSERT_VALUES_EQUAL(playerLog.IsValidUuid("'-var_dump(md5(715476815))-'"), false);
        UNIT_ASSERT_VALUES_EQUAL(playerLog.IsValidUuid("4b42f110d2ca39adbcdb56c3301c9404' and 2591=2598-- "), false);
        UNIT_ASSERT_VALUES_EQUAL(playerLog.IsValidUuid("vxvDN-4ME1w0'+(select*from(select(sleep(20)))a)+'"), false);
    }
}
