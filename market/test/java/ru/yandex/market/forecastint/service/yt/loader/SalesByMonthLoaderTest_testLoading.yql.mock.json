[{"hashKey":"c67a5c5587787401e5420e6813d3e9ce","query":"USE hahn; $formatDate = DateTime::Format(\"%Y-%m-%d\");\n\nSELECT\n    market_sku,\n    warehouse_id,\n    supplier_id,\n    `date`,\n    sum(item_count) as sales,\n    avg(item_count) as avg_sales,\n    sum(cast(sales.item_price_rub_numeric as double)) as price,\n    avg(cast(sales.item_price_rub_numeric as double)) as avg_price\nFROM RANGE (\n`/home/market/production/mstat/analyst/regular/cubes_vertica/fact_new_order_item_dict`,\n'2017-12',\n'2021-12'\n)  with inline   as sales\nJOIN `/home/market/production/mstat/analyst/regular/cubes_vertica/fact_new_order_dict`  with inline as orders\n    ON sales.order_id = orders.id\nLEFT JOIN `/home/market/production/mstat/analyst/regular/cubes_vertica/fact_new_order_delivery`  with inline as deliveries\n    ON sales.order_id = deliveries.order_id\nLEFT JOIN `/home/market/production/mstat/dictionaries/mbo/sku_transitions/latest`  with inline as sku_transitions\n    ON sales.market_sku = sku_transitions.old_entity_id\nWHERE orders.market_fulfilment_flag AND sales.warehouse_id IS NOT NULL\n    AND LENGTH(sales.real_supplier_id) > 0 AND (deliveries.shipment_datetime > '1970-01-01T00:00:00'\n    OR (orders.order_status != 'CANCELLED' AND orders.order_status != 'CANCELLED_WITHOUT_REFUND'))\n    AND DateTime::MakeDate(DateTime::ParseIso8601(orders.creation_date))\n    BETWEEN Date('2017-12-01') AND Date('2021-12-29')\nGROUP BY\n    COALESCE(sku_transitions.new_entity_id, sales.market_sku) as market_sku,\n    sales.warehouse_id as warehouse_id,\n    sales.partner_id as supplier_id,\n    $formatDate(DateTime::StartOfMonth(DateTime::ParseIso8601(orders.creation_date))) as `date`;\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"market_sku\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"warehouse_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"supplier_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"date\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"sales\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"avg_sales\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"price\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"avg_price\",[\"OptionalType\",[\"DataType\",\"Double\"]]]]]],\"Data\":[[[\"2\"],[\"171\"],[\"777\"],[\"2021-12-01\"],[\"10\"],[\"10\"],[\"655\"],[\"655\"]],[[\"107981\"],[\"171\"],[\"777\"],[\"2021-12-01\"],[\"4\"],[\"2\"],[\"1303\"],[\"651.5\"]],[[\"107983\"],[\"171\"],[\"777\"],[\"2021-12-01\"],[\"16\"],[\"4\"],[\"2634\"],[\"658.5\"]]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"3\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"61e1887fae4e0ffc78af8ab8\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-01-14T14:28:47.523Z\",\"version\":1000000}","type":"YQL_QUERY"},{"cacheKey":null,"base64Value":null,"type":"YT_DATA"}]