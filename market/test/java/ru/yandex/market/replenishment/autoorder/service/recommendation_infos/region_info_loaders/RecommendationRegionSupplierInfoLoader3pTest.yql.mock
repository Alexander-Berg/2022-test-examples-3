[{"hashKey":"f8c27460d8185737cc0a337ec53e0ba3","query":"USE hahn; PRAGMA yt.InferSchema = '1';\nPRAGMA yson.DisableStrict;\nPRAGMA AnsiInForEmptyOrNullableItemsCollections;\nPRAGMA yt.Pool = 'default';\n\n$fullfilment_partners = (\n    SELECT id\n    FROM `/home/market/production/mbi/dictionaries/partner_biz_snapshot/latest`  with inline\n    WHERE is_fullfilment = 1\n);\n\n$warehouses_with_regions = (\n    select\n        wh.id as id,\n        wh.region_id as region_id\n    from `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/warehouses`  with inline as wh\n);\n\n$stocks = (\n    select\n        msku,\n        region,\n        sum_if(st.fit, s.supplier_type = 1) as count_1p,\n        sum(st.fit) as count_overall,\n        supplier\n    from `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/stock_alpaca`  with inline as st\n        join `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/suppliers`  with inline as s\n            on st.supplier_id = s.supplier_id\n    LEFT JOIN $warehouses_with_regions AS wwr ON st.warehouse_id = wwr.id\n    where st.msku > 0\n    group by st.msku as msku, wwr.region_id as region, s.supplier_id as supplier\n);\n\n$transits = (\n    select\n        msku,\n        region,\n        sum_if(tr.in_transit, s.supplier_type = 1) as transit1p,\n        sum(tr.in_transit) as transit,\n        supplier\n    from `/home/market/production/replenishment/order_planning/2020-05-15/outputs/transits`  with inline as tr\n        join `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/suppliers`  with inline as s\n            on tr.supplier_id = s.supplier_id\n    LEFT JOIN $warehouses_with_regions AS wwr ON tr.warehouse_id = wwr.id\n    where tr.msku > 0\n    group by tr.msku as msku, wwr.region_id as region, s.supplier_id as supplier\n);\n\n$oos_by_dates = (\n    select\n        msku,\n        region,\n        supplier_id,\n        CAST(s.`date` as Date) as `date`\n    from `/home/market/production/replenishment/order_planning/2020-05-14/intermediate/suppliers_demand`  with inline as s\n        inner join $warehouses_with_regions AS wwr ON s.warehouse_id = wwr.id\n    where s.supplier_id > 0 and s.supplier_id IN $fullfilment_partners\n    group by s.msku as msku, s.supplier_id as supplier_id, s.`date`, wwr.region_id as region\n    having not bool_or(s.on_stock)\n);\n\n$oos = (\n    select\n        oos.msku as msku,\n        oos.region as region,\n        oos.supplier_id as supplier_id,\n        count_if(oos.`date` between CAST('2020-05-07' as Date) and CAST('2020-05-14' as Date)) as oos_7_days,\n        count_if(oos.`date` between CAST('2020-04-16' as Date) and CAST('2020-05-14' as Date)) as oos_28_days,\n        count(1) as oos_56_days\n    from $oos_by_dates as oos\n    group by oos.msku, oos.region, oos.supplier_id\n);\n\nselect\n    r.msku as msku,\n    wwr.region_id as region,\n    some(coalesce(st.count_1p, 0)) as stock_1p,\n    some(coalesce(st.count_overall, 0)) as stock_overall,\n    r.supplier_id as supplier_id,\n    some(coalesce(os.oos_7_days, 0)) AS oos_7_days,\n    some(coalesce(os.oos_28_days, 0)) AS oos_28_days,\n    some(coalesce(os.oos_56_days, 0)) AS oos_56_days,\n    some(tr.transit1p) as transit1p,\n    some(tr.transit) as transit\nfrom `/home/market/production/replenishment/order_planning/2020-05-15/outputs/recommendations`  with inline as r\n    left join $warehouses_with_regions AS wwr\n        on r.warehouse_id = wwr.id\n    left join $stocks as st\n        on r.msku = st.msku and wwr.region_id = st.region and st.supplier = r.supplier_id\n    LEFT JOIN $oos as os\n        ON r.msku = os.msku AND wwr.region_id = os.region AND r.supplier_id = os.supplier_id\n    left join $transits as tr\n        on r.msku = tr.msku and wwr.region_id = tr.region and r.supplier_id = tr.supplier\nwhere\n    st.msku is not null OR tr.msku is not null\ngroup by r.msku, wwr.region_id, r.supplier_id;\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"msku\",[\"DataType\",\"Int64\"]],[\"region\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"stock_1p\",[\"DataType\",\"Int64\"]],[\"stock_overall\",[\"DataType\",\"Int64\"]],[\"supplier_id\",[\"DataType\",\"Int64\"]],[\"oos_7_days\",[\"DataType\",\"Uint64\"]],[\"oos_28_days\",[\"DataType\",\"Uint64\"]],[\"oos_56_days\",[\"DataType\",\"Uint64\"]],[\"transit1p\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"transit\",[\"OptionalType\",[\"DataType\",\"Int64\"]]]]]],\"Data\":[[\"234\",[\"301\"],\"95\",\"95\",\"566631\",\"1\",\"1\",\"1\",[\"1\"],[\"1\"]],[\"123\",[\"145\"],\"95\",\"95\",\"566631\",\"0\",\"0\",\"0\",[\"1\"],[\"1\"]],[\"234\",[\"302\"],\"111\",\"111\",\"566631\",\"1\",\"1\",\"1\",[\"1\"],[\"1\"]],[\"234\",[\"300\"],\"100\",\"100\",\"566631\",\"1\",\"1\",\"1\",null,null],[\"234\",[\"145\"],\"96\",\"96\",\"566631\",\"1\",\"1\",\"1\",[\"2\"],[\"2\"]]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"74\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62c83c98d2706c22a773d746\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-07-08T14:19:17.287Z\",\"version\":1000000}","type":"YQL_QUERY"},{"cacheKey":null,"base64Value":null,"type":"YT_DATA"}]