[{"hashKey":"2d89b3784bc70c5fb259c2edc5b35ee7","query":"USE hahn; PRAGMA yt.InferSchema = '1';\nPRAGMA yson.DisableStrict;\nPRAGMA AnsiInForEmptyOrNullableItemsCollections;\nPRAGMA yt.Pool = 'default';\n\n$stocks = (\n    select\n        st.msku as msku,\n        sum_if(st.fit, s.supplier_type = 1) as count_1p,\n        sum(st.fit) as count_overall\n    from `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/stock_alpaca`  with inline as st\n        join `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/suppliers`  with inline as s\n            on st.supplier_id = s.supplier_id\n    where st.msku > 0\n    group by st.msku\n);\n\n$forecasts = (\n    SELECT\n        msku,\n        SUM_IF(f.demand, f.`date` BETWEEN '2020-05-15' AND '2020-05-28') AS sf14d_1p,\n        SUM_IF(f.demand, f.`date` BETWEEN '2020-05-15' AND '2020-06-11') AS sf28d_1p,\n        SUM_IF(f.demand, f.`date` BETWEEN '2020-05-15' AND '2020-07-09') AS sf56d_1p,\n        SUM_IF(f.total_demand, f.`date` BETWEEN '2020-05-15' AND '2020-05-28') AS sf14d,\n        SUM_IF(f.total_demand, f.`date` BETWEEN '2020-05-15' AND '2020-06-11') AS sf28d,\n        SUM_IF(f.total_demand, f.`date` BETWEEN '2020-05-15' AND '2020-07-09') AS sf56d,\n    FROM `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/forecast_region`  with inline AS f\n    GROUP BY msku\n);\n\nselect\n    r.msku as msku,\n    some(coalesce(st.count_1p, 0)) as stock_1p,\n    some(coalesce(st.count_overall, 0)) as stock_overall,\n    some(ff.sf14d_1p) as sf14d_1p,\n    some(ff.sf28d_1p) as sf28d_1p,\n    some(ff.sf56d_1p) as sf56d_1p,\n    some(ff.sf14d) as sf14d,\n    some(ff.sf28d) as sf28d,\n    some(ff.sf56d) as sf56d\nfrom `/home/market/production/replenishment/order_planning/2020-05-15/outputs/recommendations`  with inline as r\n    left join $stocks as st\n        on r.msku = st.msku\n    left join $forecasts as ff\n        on r.msku = ff.msku\ngroup by r.msku;\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"msku\",[\"DataType\",\"Int64\"]],[\"stock_1p\",[\"DataType\",\"Int64\"]],[\"stock_overall\",[\"DataType\",\"Int64\"]],[\"sf14d_1p\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf28d_1p\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf56d_1p\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf14d\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf28d\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf56d\",[\"OptionalType\",[\"DataType\",\"Double\"]]]]]],\"Data\":[[\"123\",\"190\",\"190\",[\"8.96\"],[\"11.420000000000003\"],[\"11.420000000000003\"],[\"18.279010619989883\"],[\"21.279010619989883\"],[\"21.279010619989883\"]],[\"234\",\"192\",\"192\",null,null,null,null,null,null]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"31\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62c8364d97c5b754276ce546\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-07-08T13:51:58.688Z\",\"version\":1000000}","type":"YQL_QUERY"},{"cacheKey":null,"base64Value":null,"type":"YT_DATA"}]