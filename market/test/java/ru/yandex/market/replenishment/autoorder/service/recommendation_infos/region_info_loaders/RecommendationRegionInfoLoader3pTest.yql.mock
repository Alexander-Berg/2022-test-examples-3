[{"hashKey":"44ca6540e9e941a4821cf3f2b6ddab59","query":"USE hahn; PRAGMA yt.InferSchema = '1';\nPRAGMA yson.DisableStrict;\nPRAGMA AnsiInForEmptyOrNullableItemsCollections;\nPRAGMA yt.Pool = 'default';\n\n$fullfilment_partners = (\n    SELECT id\n        FROM `/home/market/production/mbi/dictionaries/partner_biz_snapshot/latest`  with inline\n    WHERE is_fullfilment = 1\n);\n\n$warehouses_with_regions = (\n    select\n        wh.id as id,\n        wh.region_id as region_id\n    from `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/warehouses`  with inline as wh\n);\n\n$forecasts = (\n    SELECT\n        msku,\n        region,\n        SUM_IF(f.demand, f.`date` BETWEEN '2020-05-15' AND '2020-05-28') AS sf14d_1p,\n        SUM_IF(f.demand, f.`date` BETWEEN '2020-05-15' AND '2020-06-11') AS sf28d_1p,\n        SUM_IF(f.demand, f.`date` BETWEEN '2020-05-15' AND '2020-07-09') AS sf56d_1p,\n        SUM_IF(f.total_demand, f.`date` BETWEEN '2020-05-15' AND '2020-05-28') AS sf14d,\n        SUM_IF(f.total_demand, f.`date` BETWEEN '2020-05-15' AND '2020-06-11') AS sf28d,\n        SUM_IF(f.total_demand, f.`date` BETWEEN '2020-05-15' AND '2020-07-09') AS sf56d,\n    FROM `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/forecast_region`  with inline AS f\n    LEFT JOIN `/home/market/production/mstat/dictionaries/mbo/sku_transitions/latest`  with inline AS sku_transitions\n        ON f.msku = sku_transitions.old_entity_id\n    GROUP BY COALESCE(sku_transitions.new_entity_id, f.msku) as msku, f.region AS region\n);\n\n$oos_by_region_and_dates = (\n    select\n        msku,\n        region,\n        CAST(s.`date` as Date) as `date`,\n        sum(s.missed_orders) as missed_orders,\n        sum_if(s.missed_orders, sup.supplier_type = 1) as missed_orders_1p\n    from `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/suppliers_demand`  with inline as s\n        inner join `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/warehouses`  with inline as w\n        on w.id = s.warehouse_id\n        left join any `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/suppliers`  with inline as sup\n        on sup.supplier_id = s.supplier_id\n    where s.supplier_id > 0 AND s.supplier_id IN $fullfilment_partners\n    group by s.msku as msku, s.`date`, w.region_id as region\n    having not bool_or(s.on_stock)\n);\n\n$oos_by_region = (\n    SELECT\n        msku,\n        region,\n        sum_if(cast(missed_orders as double), `date` between Date('2020-04-16') and Date('2020-05-14')) as missed_orders_28d,\n        sum_if(cast(missed_orders_1p as double), `date` between Date('2020-04-16') and Date('2020-05-14')) as missed_orders_28d_1p,\n        sum(cast(missed_orders as double)) as missed_orders_56d,\n        sum(cast(missed_orders_1p as double)) as missed_orders_56d_1p,\n        count_if(`date` between CAST('2020-04-16' as Date) and CAST('2020-05-14' as Date)) as oos_28_days,\n        count(1) as oos_days\n    FROM $oos_by_region_and_dates\n    GROUP BY msku, region\n);\n\n$oos = (\n    select\n        coalesce(sku_transitions.new_entity_id, oos.msku) as msku,\n        region,\n        oos_28_days,\n        oos_days,\n        missed_orders_28d,\n        missed_orders_56d,\n        missed_orders_28d_1p,\n        missed_orders_56d_1p\n    FROM $oos_by_region as oos\n        left join `/home/market/production/mstat/dictionaries/mbo/sku_transitions/latest`  with inline as sku_transitions\n        on oos.msku = sku_transitions.old_entity_id\n);\n\n$actual_fit = (\n     SELECT\n         msku,\n         region_id,\n         fit\n     FROM `/home/market/testing/replenishment/autoorder/import_preparation/actual_fit/2020-05-15`  with inline\n);\n\n$transit = (\n    select\n        msku,\n        region,\n        sum_if(in_transit, s.supplier_type = 1) as transit1p,\n        sum(in_transit) as transit\n    from\n        `/home/market/production/replenishment/order_planning/2020-05-15/outputs/transits`  with inline as t\n    join `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/suppliers`  with inline as s\n            on t.supplier_id = s.supplier_id\n    left join $warehouses_with_regions AS wwr ON t.warehouse_id = wwr.id\n    left join `/home/market/production/mstat/dictionaries/mbo/sku_transitions/latest`  with inline as sku_transitions\n            on t.msku = sku_transitions.old_entity_id\n\n    group by coalesce(sku_transitions.new_entity_id, t.msku) as msku, wwr.region_id as region\n);\n\n$stocks = (\n    select\n        msku,\n        region,\n        sum_if(st.fit, s.supplier_type = 1) as count_1p,\n        sum(st.fit) as count_overall\n    from `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/stock_alpaca`  with inline as st\n        join `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/suppliers`  with inline as s\n            on st.supplier_id = s.supplier_id\n        left join $warehouses_with_regions AS wwr\n            on st.warehouse_id = wwr.id\n        left join `/home/market/production/mstat/dictionaries/mbo/sku_transitions/latest`  with inline as sku_transitions\n            on st.msku = sku_transitions.old_entity_id\n    where st.msku > 0\n    group by coalesce(sku_transitions.new_entity_id, st.msku) as msku, wwr.region_id as region\n);\n\n$recommendations = (\n    select\n        coalesce(sku_transitions.new_entity_id, rec.msku) as msku,\n        rec.warehouse_id as warehouse_id\n    from `/home/market/production/replenishment/order_planning/2020-05-15/outputs/recommendations`  with inline as rec\n    left join `/home/market/production/mstat/dictionaries/mbo/sku_transitions/latest`  with inline as sku_transitions\n            on rec.msku = sku_transitions.old_entity_id\n);\n\nselect\n    r.msku as msku,\n    wwr.region_id as region,\n    some(ff.sf14d_1p) as sf14d_1p,\n    some(ff.sf28d_1p) as sf28d_1p,\n    some(ff.sf56d_1p) as sf56d_1p,\n    some(ff.sf14d) as sf14d,\n    some(ff.sf28d) as sf28d,\n    some(ff.sf56d) as sf56d,\n    some(coalesce(oos.oos_28_days, 0)) as oos_28_days,\n    some(coalesce(oos.oos_days, 0)) as oos_days,\n    some(coalesce(oos.missed_orders_28d, 0)) as missed_orders_28d,\n    some(coalesce(oos.missed_orders_56d, 0)) as missed_orders,\n    some(coalesce(oos.missed_orders_28d_1p, 0)) as missed_orders_28d_1p,\n    some(coalesce(oos.missed_orders_56d_1p, 0)) as missed_orders_1p,\n    some(coalesce(act_fit.fit, 0)) as actual_fit,\n    some(t.transit1p) as transit1p,\n    some(t.transit) as transit,\n    some(coalesce(st.count_1p, 0)) as stock_1p,\n    some(coalesce(st.count_overall, 0)) as stock_overall\nfrom $recommendations as r\n    left join $warehouses_with_regions AS wwr\n        on r.warehouse_id = wwr.id\n    left join $forecasts as ff\n        on r.msku = ff.msku and wwr.region_id = ff.region\n    left join $oos as oos\n        on r.msku = oos.msku and wwr.region_id = oos.region\n    left join $actual_fit as act_fit\n        on r.msku = act_fit.msku and wwr.region_id = act_fit.region_id\n    left join $transit as t\n        on r.msku = t.msku and wwr.region_id = t.region\n    left join $stocks as st\n        on r.msku = st.msku and wwr.region_id = st.region\nwhere\n    ff.msku is not null or\n    oos.msku is not null or\n    act_fit.msku is not null or\n    t.msku is not null or\n    st.msku is not null\ngroup by r.msku, wwr.region_id;\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"msku\",[\"DataType\",\"Int64\"]],[\"region\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"sf14d_1p\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf28d_1p\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf56d_1p\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf14d\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf28d\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf56d\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"oos_28_days\",[\"DataType\",\"Uint64\"]],[\"oos_days\",[\"DataType\",\"Uint64\"]],[\"missed_orders_28d\",[\"DataType\",\"Double\"]],[\"missed_orders\",[\"DataType\",\"Double\"]],[\"missed_orders_28d_1p\",[\"DataType\",\"Double\"]],[\"missed_orders_1p\",[\"DataType\",\"Double\"]],[\"actual_fit\",[\"DataType\",\"Int64\"]],[\"transit1p\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"transit\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"stock_1p\",[\"DataType\",\"Int64\"]],[\"stock_overall\",[\"DataType\",\"Int64\"]]]]],\"Data\":[[\"123\",[\"145\"],[\"4.48\"],[\"5.710000000000001\"],[\"5.710000000000001\"],[\"12.63950530999494\"],[\"14.63950530999494\"],[\"14.63950530999494\"],\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"1318\",[\"10\"],[\"10\"],\"95\",\"95\"],[\"234\",[\"145\"],null,null,null,null,null,null,\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"0\",[\"11\"],[\"11\"],\"96\",\"96\"],[\"234\",[\"302\"],null,null,null,null,null,null,\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"0\",null,null,\"0\",\"0\"],[\"234\",[\"301\"],null,null,null,null,null,null,\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"0\",null,null,\"0\",\"0\"],[\"234\",[\"300\"],null,null,null,null,null,null,\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"0\",null,null,\"0\",\"0\"],[\"234\",[\"303\"],null,null,null,null,null,null,\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"0\",null,null,\"0\",\"0\"]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"132\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62d6a798054af0b0d3c26ebd\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-07-19T12:47:37.863Z\",\"version\":1000000}","type":"YQL_QUERY"},{"cacheKey":null,"base64Value":null,"type":"YT_DATA"}]