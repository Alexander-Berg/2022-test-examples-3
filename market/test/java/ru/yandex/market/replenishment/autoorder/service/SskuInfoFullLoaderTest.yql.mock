[{"hashKey":"d2c31548ab546909af439f92aa2bae23","query":"USE hahn; PRAGMA DisableAnsiInForEmptyOrNullableItemsCollections;\n\n$fullfilment_partners = (\n    SELECT id\n        FROM `/home/market/production/mbi/dictionaries/partner_biz_snapshot/latest`  with inline\n        WHERE is_fullfilment = 1\n);\n\n-- Mappings for SSKU <-> (supplier_id/rs_id) && (msku/shop_sku)\n$ssku_msku_mapping = (\n    SELECT\n        IF(\n            m.approved_sku_mapping_id > 0,\n            m.approved_sku_mapping_id,\n            ofs.approved_market_sku_id\n        ) AS msku,\n        ofs.raw_shop_sku as shop_sku,\n        ofs.raw_supplier_id as supplier_id,\n        IF(m.approved_sku_mapping_ts > 0, m.approved_sku_mapping_ts, 0) AS approved_timestamp,\n        IF(\n            s.real_supplier_id IS NULL OR s.real_supplier_id = '',\n            '3p.' || CAST(ofs.raw_supplier_id AS String) || '.' || ofs.raw_shop_sku,\n            s.real_supplier_id || '.' || ofs.raw_shop_sku\n        ) AS ssku,\n        ofs.bar_code AS barcode,\n        ofs.title as title\n    FROM `/home/market/production/mbo/stat/mboc_offers_expanded_sku/latest`  with inline AS ofs\n        JOIN `/home/market/production/mbi/dictionaries/partner_biz_snapshot/latest`  with inline AS s\n            ON s.id = ofs.raw_supplier_id\n        LEFT JOIN `/home/market/production/mbo/mboc/offer-mapping`  with inline AS m\n            ON ofs.raw_shop_sku = m.shop_sku and ofs.business_id = m.business_id\n    WHERE s.is_fullfilment = 1 and (m.approved_sku_mapping_id > 0 OR ofs.approved_market_sku_id > 0)\n);\n\n$mapDayOfWeek = ($x) -> {\n   RETURN CASE $x\n       WHEN \"MONDAY\" THEN \"пн\"\n       WHEN \"TUESDAY\" THEN \"вт\"\n       WHEN \"WEDNESDAY\" THEN \"ср\"\n       WHEN \"THURSDAY\" THEN \"чт\"\n       WHEN \"FRIDAY\" THEN \"пт\"\n       WHEN \"SATURDAY\" THEN \"сб\"\n       WHEN \"SUNDAY\" THEN \"вс\"\n       ELSE null\n   END\n};\n\n$parseSchedule = ($data) -> {\n    RETURN ListConcat(\n               ListFilter(\n                    ListMap(\n                        Yson::LookupList(\n                            $data,\n                            'supplySchedule',\n                            Yson::Options(false as Strict)\n                        ),\n                        ($x) -> { RETURN $mapDayOfWeek(Yson::LookupString($x, 'dayOfWeek')); }\n                    ),\n                    ($x) -> { RETURN $x is not null; }\n                ),\n                \", \"\n            );\n};\n\n$master_data = (\n    SELECT\n        m.supplier_id   AS supplier_id,\n        m.shop_sku      AS shop_sku,\n        SOME(Yson::LookupString(\n            m.data,\n            'manufacturer',\n            Yson::Options(false as Strict)\n        ))              AS name,\n        SOME(Yson::LookupDouble(\n            m.data,\n            'quantumOfSupply'\n        ))              AS shipment_quantum,\n        SOME(Yson::LookupDouble(\n            m.data,\n            'minShipment'\n        ))              AS min_shipment,\n        SOME(Yson::LookupDouble(\n            m.data,\n            'transportUnitSize',\n            Yson::Options(true as AutoConvert)\n        ))              AS transport_unit_size,\n        SOME($parseSchedule(m.data)) AS supply_schedule\n    FROM `/home/market/production/mstat/dictionaries/mdm/master_data/latest`  with inline AS m\n    WHERE m.supplier_id > 0\n        AND m.supplier_id IN $fullfilment_partners\n        AND m.shop_sku IS NOT NULL\n        AND m.shop_sku != ''\n        AND m.data IS NOT NULL\n    GROUP BY m.supplier_id, m.shop_sku\n);\n\n-- Единственный вариант, как мы в теории можем определять 1р поставщиков.\n-- К сожалению, абсолютную гарантию он не дает, но в этой таблице попросту\n-- нет колонок, которые бы точно дали понять, как формировать SSKU.\n$weight_and_dimensions = (\n    SELECT\n        CASE WHEN supplier_id = 465852 THEN\n            shop_sku\n        ELSE\n            '3p.' || CAST(supplier_id AS String) || '.' || shop_sku\n        END                                                     AS ssku,\n        CAST(SOME(height_micrometer_value) AS Int64) / 10000    AS height,\n        CAST(SOME(length_micrometer_value) AS Int64) / 10000    AS length,\n        CAST(SOME(width_micrometer_value) AS Int64) / 10000     AS width,\n        CAST(SOME(gross_mg_value) AS Int64) / 1000              AS weight,\n    FROM `/home/market/production/mdm/dictionaries/reference_item/1d/latest`  with inline\n    WHERE supplier_id > 0 AND shop_sku IS NOT NULL AND shop_sku != ''AND supplier_id IN $fullfilment_partners\n    GROUP BY supplier_id, shop_sku\n);\n\n$supply_prices = (\n    SELECT\n         '3p.' || CAST(supplier_id AS String) || '.' || CAST(article AS String) as ssku,\n         supplier_id,\n         MAX_BY(CAST(supply_price as double), id) AS supply_price\n    FROM `/home/market/production/mstat/dictionaries/fulfillment_request_item/1d/latest`  with inline\n    WHERE real_supplier_id IS NULL OR real_supplier_id = '' AND supplier_id IN $fullfilment_partners\n          AND CAST(supply_price as double) > 0\n    GROUP BY supplier_id,article\n);\n\nSELECT\n    m.ssku                  AS ssku,\n    m.msku                  AS msku,\n    m.supplier_id           AS supplier_id,\n    m.approved_timestamp    AS approved_timestamp,\n    md.name                 AS manufacturer,\n    m.barcode               AS barcode,\n    d.height                AS height,\n    d.length                AS length,\n    d.width                 AS width,\n    d.weight                AS weight,\n    md.shipment_quantum     AS shipment_quantum,\n    md.min_shipment         AS min_shipment,\n    md.transport_unit_size  AS transport_unit_size,\n    sp.supply_price         AS supply_price,\n    md.supply_schedule      AS supply_schedule,\n    ss.status               AS status,\n    m.title                 AS title\nFROM $ssku_msku_mapping AS m\n    LEFT JOIN $master_data AS md\n        ON md.supplier_id = m.supplier_id AND md.shop_sku = m.shop_sku\n    LEFT JOIN $weight_and_dimensions AS d\n        ON d.ssku = m.ssku\n    LEFT JOIN $supply_prices AS sp\n        ON sp.ssku = m.ssku\n    LEFT JOIN `/home/market/production/deepmind/dictionaries/ssku_status/latest`  with inline AS ss\n        ON ss.shop_sku = m.ssku and ss.raw_supplier_id = m.supplier_id\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"ssku\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"msku\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"supplier_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"approved_timestamp\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"manufacturer\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"barcode\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"height\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"length\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"width\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"weight\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"shipment_quantum\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"min_shipment\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"transport_unit_size\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"supply_price\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"supply_schedule\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"status\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"title\",[\"OptionalType\",[\"DataType\",\"String\"]]]]]],\"Data\":[[[\"3p.420420.004000\"],[\"234\"],[\"420420\"],[\"1614870514000\"],null,null,[\"2\"],[\"20\"],[\"2\"],[\"20\"],null,null,null,[\"123.45\"],null,null,[\"title1\"]],[[\"3p.420420.004200\"],[\"345\"],[\"420420\"],[\"1614866832000\"],[\"Test\"],[\"1337420133700\"],null,null,null,null,[\"2\"],[\"4\"],[\"0\"],[\"321.54\"],[\"пн, вт, ср, чт, пт, сб, вс\"],null,[\"title2\"]],[[\"004001.004001\"],[\"123\"],[\"465852\"],[\"1614841511000\"],null,[\"4601185007202\"],[\"1\"],[\"10\"],[\"1\"],[\"10\"],null,null,null,null,null,[\"INACTIVE\"],[\"title4\"]],[[\"004001.004000\"],[\"234\"],[\"465852\"],[\"1614863192000\"],null,null,null,null,null,null,null,null,null,null,null,null,[\"title3\"]],[[\"004066.004003\"],[\"234\"],[\"644283\"],[\"1614870514000\"],[\"Учитель\"],[\"4601185007202\"],null,null,null,null,[\"5\"],[\"10\"],[\"1\"],null,null,null,[\"title8\"]],[[\"004000.004000\"],[\"234\"],[\"566631\"],[\"1593864315000\"],[\"Учитель\"],[\"4601185007202\"],null,null,null,null,[\"5\"],[\"10\"],[\"2\"],null,null,[\"ACTIVE\"],[\"title5\"]],[[\"004000.004001\"],[\"123\"],[\"566631\"],[\"1589537687000\"],null,null,[\"1\"],[\"10\"],[\"1\"],[\"10\"],null,null,null,null,null,null,[\"title6\"]]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"127\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62b1aafdc970bdd234602f8e\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-06-21T11:27:42.421Z\",\"version\":1000000}","type":"YQL_QUERY"},{"cacheKey":null,"base64Value":null,"type":"YT_DATA"}]