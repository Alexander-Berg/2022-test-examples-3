[{"hashKey":"a2f0442b00ba4eb09dcf36a44a6187b6","query":"USE hahn; PRAGMA yt.InferSchema = '1';\nPRAGMA yson.DisableStrict;\nPRAGMA AnsiInForEmptyOrNullableItemsCollections;\nPRAGMA yt.Pool = 'default';\n\n-- склады\n$warehouses_with_regions = (\n    select\n        wh.id as id,\n        wh.region_id as region_id\n    from `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/warehouses`  with inline as wh\n);\n\n--сейфти сток\n$safety_stocks_by_region = (\n    SELECT\n        s.msku                              AS msku,\n        s.region                            AS region,\n        s.safety_stock                      AS safety_stock,\n        s.`date`                            AS `date`\n    FROM `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/ss_region_reduced`  with inline AS s\n);\n\n--safety stock по стране\n$safety_stocks_country_wide = (\n    SELECT\n        s.msku                              AS msku,\n        SUM(s.safety_stock)                 AS safety_stock,\n        s.`date`                            AS `date`\n    FROM `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/ss_region_reduced`  with inline AS s\n    GROUP BY s.msku, s.`date`\n);\n\n--ручной сток\n$manual_stocks = (\n    select\n       msku, region, max_items, max_items_by_days, min_items, min_items_by_days, `date`\n    from `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/manual_stock_model`  with inline\n);\n\nselect\n    r.lead_time as delivery_time,\n    r.`date` as delivery_date,\n    r.order_date as order_date,\n    r.xdoc_date as xdoc_date,\n    r.warehouse_id as warehouse_id,\n    WeakField(r.warehouse_id_from, Int64) as warehouse_id_from,\n    r.supplier_id as supplier_id,\n    r.qty as purch_qty,\n    WeakField(r.distr_demand, Int64, 0) as distr_demand,\n    r.msku as msku,\n    r.min_shipment as min_shipment,\n    r.shipment_quantum as shipment_quantum,\n    r.delivery_type as supply_route,\n    r.ssku as ssku,\n    WeakField(r.has_cheaper, Bool, false) as has_cheaper_recommendation,\n    case when WeakField(r.distr_demand, Int64, 0) > 0 then\n        Math::Round(ss_country.safety_stock, -1)\n    else\n        Math::Round(ss_region_reduced.safety_stock, -1)\n    end as safety_stock,\n    ms.max_items as max_items,\n    ms.max_items_by_days as max_items_by_days,\n    ms.min_items as min_items,\n    ms.min_items_by_days as min_items_by_days,\n    r.post_opt_comment as reason_of_recommendation,\n    r.inactive as inactive,\n    r.inactive_reason as inactive_reason\nfrom `/home/market/production/replenishment/order_planning/2020-05-15/outputs/recommendations_3p`  with inline as r\n    left join $warehouses_with_regions as wwr\non r.warehouse_id = wwr.id\n    left join $safety_stocks_by_region as ss_region_reduced\non r.msku = ss_region_reduced.msku\n        and wwr.region_id = ss_region_reduced.region\n        and r.`date` = ss_region_reduced.`date`\n    left join $safety_stocks_country_wide as ss_country\non r.msku = ss_country.msku and r.`date` = ss_country.`date`\n    left join $manual_stocks as ms\non r.msku = ms.msku and wwr.region_id = ms.region and r.`date` = ms.`date`\nwhere\n    delivery_type != 'inter-warehouse movement'\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"delivery_time\",[\"DataType\",\"Int64\"]],[\"delivery_date\",[\"DataType\",\"String\"]],[\"order_date\",[\"DataType\",\"String\"]],[\"xdoc_date\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"warehouse_id\",[\"DataType\",\"Int64\"]],[\"warehouse_id_from\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"supplier_id\",[\"DataType\",\"Int64\"]],[\"purch_qty\",[\"DataType\",\"Int64\"]],[\"distr_demand\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"msku\",[\"DataType\",\"Int64\"]],[\"min_shipment\",[\"DataType\",\"Int64\"]],[\"shipment_quantum\",[\"DataType\",\"Int64\"]],[\"supply_route\",[\"DataType\",\"String\"]],[\"ssku\",[\"DataType\",\"String\"]],[\"has_cheaper_recommendation\",[\"OptionalType\",[\"DataType\",\"Bool\"]]],[\"safety_stock\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"max_items\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"max_items_by_days\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"min_items\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"min_items_by_days\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"reason_of_recommendation\",[\"DataType\",\"String\"]],[\"inactive\",[\"DataType\",\"Bool\"]],[\"inactive_reason\",[\"DataType\",\"String\"]]]]],\"Data\":[[\"4\",\"2020-05-25\",\"2020-05-21\",null,\"145\",null,\"566631\",\"0\",[\"0\"],\"123\",\"10\",\"10\",\"direct\",\"10000\",[false],[\"2.8\"],null,[\"39.29002695744109\"],null,[\"29.46752021808082\"],\"comment\",false,\"\"],[\"4\",\"2020-05-29\",\"2020-05-25\",null,\"145\",null,\"566631\",\"2\",[\"0\"],\"123\",\"10\",\"10\",\"direct\",\"20000\",[false],[\"3.2\"],null,[\"39.29002695744109\"],null,[\"29.46752021808082\"],\"comment\",false,\"\"],[\"4\",\"2020-06-05\",\"2020-06-01\",null,\"145\",null,\"566631\",\"4\",[\"0\"],\"234\",\"10\",\"10\",\"direct\",\"30000\",[false],null,null,null,null,null,\"comment\",false,\"\"],[\"4\",\"2020-06-05\",\"2020-06-01\",null,\"145\",null,\"566631\",\"4\",[\"0\"],\"123\",\"10\",\"10\",\"direct\",\"30000\",[false],[\"4.4\"],null,null,null,null,\"comment\",false,\"\"],[\"4\",\"2020-05-29\",\"2020-05-25\",null,\"145\",null,\"566631\",\"2\",[\"0\"],\"234\",\"10\",\"10\",\"direct\",\"20000\",[false],null,null,null,null,null,\"comment\",false,\"\"],[\"4\",\"2020-05-25\",\"2020-05-21\",null,\"145\",null,\"566631\",\"0\",[\"0\"],\"234\",\"10\",\"10\",\"direct\",\"10000\",[false],null,null,null,null,null,\"comment\",false,\"\"]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"41\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62d03672054af0b0d3bd6833\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-07-14T15:31:31.381Z\",\"version\":1000000}","type":"YQL_QUERY"},{"cacheKey":null,"base64Value":null,"type":"YT_DATA"}]