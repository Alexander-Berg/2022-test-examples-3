[{"hashKey":"8808a00db153f9cc5becab71227995a8","query":"USE hahn; PRAGMA AnsiInForEmptyOrNullableItemsCollections;\n\n$date_format = DateTime::Format(\"%Y-%m-%d\");\n$datetime_parser = DateTime::Parse(\"%Y-%m-%d %H:%M:%S\");\n\n$cur_date = Date(\"2022-06-09\");\n\n$warehouses = SELECT id\n              FROM `/home/market/production/replenishment/order_planning/latest/intermediate/warehouses`  with inline\n              WHERE id IS NOT NULL;\n\n$promohacks = (\nSELECT\n    String::SplitToList(ph.ssku, '.', 1 as Limit)[0] as rs_id,\n    ph.ssku as ssku,\n    ph.wave as title,\n    ph.needed_purchase as needed_purchase,\n    $datetime_parser(ph.analitical_start_wave_date) as start_date,\n    $datetime_parser(ph.analitical_end_wave_date) as end_date\nFROM `/home/market/production/mstat/dictionaries/pricing_mgmt/promohack/hack_ssku_promo_for_analytics_view/latest`  with inline as ph\n);\n\n$result =\n    -- 1p\n    SELECT\n        $date_format(MIN(ph.start_date)) as start_date,\n        $date_format(MIN_BY(ph.end_date, ph.start_date)) as end_date,\n        ph.ssku as ssku,\n        w.id as warehouse_id,\n        MIN_BY(ph.title, ph.start_date) as title,\n        MIN_BY(ph.needed_purchase, ph.start_date) as needed_purchase\n    FROM $promohacks as ph\n        INNER JOIN `/home/market/production/mstat/dictionaries/shop_real_supplier/latest`  with inline as srs\n            ON ph.rs_id = srs.rs_id\n        LEFT JOIN `/home/market/production/mstat/dictionaries/mbo/mboc_logistics_params/latest`  with inline as mboc\n            ON mboc.supplier_id = srs.id\n        CROSS JOIN $warehouses as w\n    WHERE\n        ph.start_date >= ($cur_date + DateTime::IntervalFromDays(cast(COALESCE(mboc.delivery_time,1) as Int16)))\n    GROUP BY ph.ssku, w.id;\n\n-- For test purpose, to select a few rows\nSELECT *\nFROM $result\n\n\n\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"end_date\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"needed_purchase\",[\"OptionalType\",[\"DataType\",\"Bool\"]]],[\"ssku\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"start_date\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"title\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"warehouse_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]]]]],\"Data\":[[[\"2022-06-12\"],[false],[\"001001.tovar01\"],[\"2022-06-11\"],[\"super-sale\"],[\"145\"]],[[\"2022-06-12\"],[false],[\"001001.tovar01\"],[\"2022-06-11\"],[\"super-sale\"],[\"301\"]],[[\"2022-06-12\"],null,[\"001002.tovar02\"],[\"2022-06-11\"],[\"super-sale-1\"],[\"145\"]],[[\"2022-06-12\"],null,[\"001002.tovar02\"],[\"2022-06-11\"],[\"super-sale-1\"],[\"301\"]]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"43\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62d57828ae4e0fd2730dc301\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-07-18T15:12:26.858Z\",\"version\":1000000}","type":"YQL_QUERY"},{"cacheKey":null,"base64Value":null,"type":"YT_DATA"}]