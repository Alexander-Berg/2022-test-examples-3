[{"hashKey":"f376dd0fdcf19ec65089e481a3feefca","query":"USE hahn; PRAGMA yt.InferSchema = '1';\nPRAGMA yson.DisableStrict;\nPRAGMA AnsiInForEmptyOrNullableItemsCollections;\nPRAGMA yt.Pool = 'default';\n\n$is_moscow = ($warehouse_id) -> {\n   return $warehouse_id in (145, 171, 172);\n};\n\n$near_stock = ($w_id, $stock, $m_stock) -> {\n   return\n      case when $is_moscow($w_id) then\n        coalesce($m_stock, 0) - coalesce($stock, 0)\n      else\n        null end;\n};\n\n$transit = (\n    select\n        t.msku as msku,\n        t.warehouse_id as warehouse_id,\n        sum_if(t.in_transit, s.supplier_type = 1) as transit1p,\n        sum(t.in_transit) as transit\n    from\n        `/home/market/production/replenishment/order_planning/2020-05-15/outputs/transits`  with inline as t\n        join `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/suppliers`  with inline as s\n            on t.supplier_id = s.supplier_id\n    group by t.msku, t.warehouse_id);\n\n-- стоки\n$stocks = (\n    select\n        st.msku as msku,\n        st.warehouse_id as warehouse_id,\n        sum_if(st.fit, s.supplier_type = 1) as count_1p,\n        sum(st.fit) as count_overall\n    from `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/stock_alpaca`  with inline as st\n        join `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/suppliers`  with inline as s\n            on st.supplier_id = s.supplier_id\n    where st.msku > 0\n    group by st.msku, st.warehouse_id\n);\n\n-- стоки московских складов\n$moscow_stocks = (\n    select\n        st.msku as msku,\n        sum_if(st.fit, s.supplier_type = 1) as count_1p,\n        sum(st.fit) as count_overall\n    from `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/stock_alpaca`  with inline as st\n        join `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/suppliers`  with inline as s\n            on st.supplier_id = s.supplier_id\n    where st.msku > 0\n        and $is_moscow(st.warehouse_id)\n    group by st.msku\n);\n\nselect\n    r.warehouse_id as warehouse_id,\n    r.msku as msku,\n    some(t.transit1p) as transit1p,\n    some(t.transit) as transit,\n    some(coalesce(st.count_1p, 0)) as stock_1p,\n    some(coalesce(st.count_overall, 0)) as stock_overall,\n    some($near_stock(r.warehouse_id, st.count_1p, m_st.count_1p)) as near_stock_1p,\n    some($near_stock(r.warehouse_id, st.count_overall, m_st.count_overall)) as near_stock_overall\nfrom `/home/market/production/replenishment/order_planning/2020-05-15/outputs/recommendations`  with inline as r\n    left join $transit as t\n        on r.msku = t.msku and r.warehouse_id = t.warehouse_id\n    left join $stocks as st\n        on r.msku = st.msku and r.warehouse_id = st.warehouse_id\n    left join $moscow_stocks as m_st\n        on r.msku = m_st.msku\ngroup by r.msku, r.warehouse_id;\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"warehouse_id\",[\"DataType\",\"Int64\"]],[\"msku\",[\"DataType\",\"Int64\"]],[\"transit1p\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"transit\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"stock_1p\",[\"DataType\",\"Int64\"]],[\"stock_overall\",[\"DataType\",\"Int64\"]],[\"near_stock_1p\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"near_stock_overall\",[\"OptionalType\",[\"DataType\",\"Int64\"]]]]]],\"Data\":[[\"145\",\"123\",[\"10\"],[\"10\"],\"95\",\"95\",[\"0\"],[\"0\"]],[\"145\",\"234\",[\"11\"],[\"11\"],\"96\",\"96\",[\"0\"],[\"0\"]]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"58\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62d03b23ae4e0fd27309d11b\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-07-14T15:51:38.792Z\",\"version\":1000000}","type":"YQL_QUERY"},{"cacheKey":null,"base64Value":null,"type":"YT_DATA"}]