[{"hashKey":"d41d8cd98f00b204e9800998ecf8427e","query":"USE hahn; -- WARNING: не нужно оборачивать названия таблиц в tbl()! Тест работает исключительно через кэш YT из файлика\n-- \"AssortmentLoaderTest_testLoading.yql.mock\"\nPRAGMA DisableAnsiInForEmptyOrNullableItemsCollections;\n\n$exctract_date = ($dateString) -> {\n    return DateTime::MakeDate(DateTime::Parse(\"%Y-%m-%d\")(COALESCE($dateString, \"\")));\n};\n\n$fullfilment_partners = (\n    SELECT id\n        FROM `//home/market/production/mbi/dictionaries/partner_biz_snapshot/latest`\n        WHERE is_fullfilment = 1\n);\n\n$msku_with_fullfilment_supplier = (\n    SELECT approved_market_sku_id as msku\n    FROM `//home/market/production/ir/ultra-controller/supplier_to_market_sku`\n    WHERE shop_id in $fullfilment_partners\n);\n\n$abc = (\n    SELECT DISTINCT\n        market_sku as msku,\n    -- Здесь может быть несколько разных abc_gmv за одну дату, выберется случайная\n        MAX_BY(abc_gmv, $exctract_date(`date`)) as abc\n    FROM `//home/market/production/analytics/business/operations/replenishment/abc/total/latest`\n    WHERE `date` is not null\n        AND market_sku IN $msku_with_fullfilment_supplier\n    GROUP BY market_sku\n);\n\n\n$departments = (\n    SELECT\n        msku_msku as msku,\n        some(msku_category_category_directors_category_team) as department_name\n    FROM `//home/market/production/mstat/analyst/regular/cubes_vertica/dim_ssku_flattened`\n    WHERE msku_category_category_directors_category_team != ''\n        AND shop_id IN $fullfilment_partners\n    GROUP BY msku_msku\n);\n\n-- Эта часть вынесена в подзапрос, потому что такой хак магическим образом уменьшает время выгрузки YT с ~ 4,5 минут\n-- до < 3,5 минут\n$assortment = (\n    SELECT\n        model_id    AS msku,\n        title,\n        category_id,\n        CAST(\n            Listhead(\n                ListFilter(data.parameter_values, ($x) -> {\n                    return $x.xsl_name = 'packageNumInSpike'\n                })\n            ).numeric_value\n            as Uint32\n        )           AS package_num_in_spike,\n        Listhead(\n            ListFilter(data.parameter_values, ($c) -> {\n                return $c.xsl_name IN ('cargoType980','cargoType985','cargoType990') AND $c.bool_value\n            })\n        ).xsl_name AS honest_sign,\n        data.modified_ts AS modified_ts\n        FROM `//home/market/production/mbo/export/recent/models/sku`\n        WHERE model_id > 0 AND title != '' AND category_id > 0\n        AND model_id IN $msku_with_fullfilment_supplier\n                AND data.modified_ts > 1647831300000\n        ORDER BY modified_ts  ASC LIMIT 100000\n        );\n\n\n$fact_golden_matrix = (\n    SELECT DISTINCT market_sku  AS msku\n    FROM `//home/market/production/mstat/analyst/regular/cubes_vertica/fact_golden_matrix`\n    WHERE market_sku IS NOT NULL\n        AND market_sku IN $msku_with_fullfilment_supplier\n);\n\n$vendor_and_reserve_title_info = (\n    SELECT\n        o.approved_market_sku_id AS msku,\n        some(if(vendor_id > 0, vendor_id)) as vendor_id,\n        some(if(vendor_code is not null AND vendor_code != '', vendor_code)) as vendor_code,\n        some(if(title is not null AND title != '', title)) as reserve_title\n    FROM `//home/market/production/mbo/stat/mboc_offers_expanded_sku/latest` AS o\n    WHERE o.approved_market_sku_id > 0\n        AND o.supplier_id IN $fullfilment_partners\n    GROUP BY o.approved_market_sku_id\n);\n\nSELECT\n    a.msku                              AS msku,\n    coalesce(a.title, vi.reserve_title) AS title,\n    a.category_id               AS category_id,\n    a.package_num_in_spike      AS package_num_in_spike,\n    a.modified_ts               AS modified_ts,\n    a.honest_sign               AS honest_sign,\n    abc.abc                     AS abc,\n    d.department_name           AS department_name,\n    fgm.msku IS NOT NULL        AS core_fix_matrix,\n    vi.vendor_code              AS vendor_code,\n    vi.vendor_id                AS vendor_id\nFROM $assortment AS a\n    LEFT JOIN $abc AS abc ON abc.msku = a.msku\n    LEFT JOIN $departments AS d ON d.msku = a.msku\n    LEFT JOIN $fact_golden_matrix AS fgm ON fgm.msku = a.msku\n    LEFT JOIN $vendor_and_reserve_title_info AS vi ON vi.msku = a.msku WHERE a.msku IN (101282719896);","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"msku\",[\"OptionalType\",[\"DataType\",\"Uint64\"]]],[\"title\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"category_id\",[\"OptionalType\",[\"DataType\",\"Uint64\"]]],[\"package_num_in_spike\",[\"OptionalType\",[\"DataType\",\"Uint32\"]]],[\"modified_ts\",[\"OptionalType\",[\"DataType\",\"Uint64\"]]],[\"honest_sign\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"abc\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"department_name\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"core_fix_matrix\",[\"DataType\",\"Bool\"]],[\"vendor_code\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"vendor_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]]]]],\"Data\":[[[\"101282719896\"],[\"Uniroyal MS Plus 77 255/55 R18 109V зимняя\"],[\"90490\"],null,[\"1647842214397\"],[\"cargoType980\"],[\"D\"],[\"DIY & Auto\"],false,null,[\"152762\"]]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"91\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"6250571c054af09bf46b59c6\",\"issues\":[{\"code\":1070,\"column\":0,\"file\":\"<main>\",\"issues\":[{\"code\":0,\"column\":0,\"file\":\"<main>\",\"issues\":[],\"message\":\"DQ cannot execute the query. Cause: dynamic table\",\"row\":0,\"severity\":\"S_INFO\"}],\"message\":\"Optimization\",\"row\":0,\"severity\":\"S_INFO\"}],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-04-08T16:00:36.124Z\",\"version\":1000000}","type":"YQL_QUERY"},{"cacheKey":null,"base64Value":null,"type":"YT_DATA"}]