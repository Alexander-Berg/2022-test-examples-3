[{"hashKey":"a644ce9aa1797b1aded4bd5992f752d1","query":"USE hahn; $format = DateTime::Format(\"%Y-%m\");\n$prev_month = $format(DateTime::StartOfMonth(DateTime::ShiftMonths(Date(\"2022-06-15\"), -1)));\n$prev_prev_month = $format(DateTime::StartOfMonth(DateTime::ShiftMonths(Date(\"2022-06-15\"), -2)));\n\nSELECT vendor_id,\n       hid,\n       SUM(gross_margin_rub) / SUM(cast(nmv_rub_numeric as double))                                                               as gross_margin_by_vendor_hid,\n       (SUM(SUM(gross_margin_rub)) OVER (PARTITION BY hid)) / (SUM(SUM(cast(nmv_rub_numeric as double))) OVER (PARTITION BY hid)) as gross_margin_by_hid\n\nFROM RANGE(`/home/market/production/mstat/analyst/regular/cubes_vertica/fact_ue_partitioned`, $prev_prev_month, $prev_month)\nwhere supplier_type = \"1P\" and vendor_id > 0\nGROUP BY\n    vendor_id,\n    hid\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"vendor_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"hid\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"gross_margin_by_vendor_hid\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"gross_margin_by_hid\",[\"OptionalType\",[\"DataType\",\"Double\"]]]]]],\"Data\":[[[\"152883\"],[\"90471\"],[\"0.36019463788200506\"],[\"0.004897234343038909\"]],[[\"16714333\"],[\"90471\"],[\"-0.03279258404236152\"],[\"0.004897234343038909\"]]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"5\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62cbfa8d97c5b754276f89ca\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-07-11T10:25:22.885Z\",\"version\":1000000}","type":"YQL_QUERY"},{"cacheKey":null,"base64Value":null,"type":"YT_DATA"}]