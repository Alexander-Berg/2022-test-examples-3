[{"hashKey":"d41d8cd98f00b204e9800998ecf8427e","query":"USE hahn; $date_format = DateTime::Format(\"%Y-%m-%d\");\n\n$cur_date = Date(\"2021-11-30\");\n\n$p =\nSELECT Unwrap(promo_key, \"unique-string-q7e82h1j3\")            as promo_key,\n       DateTime::FromSeconds(CAST(promo.start_date as Uint32)) as start_date,\n       DateTime::FromSeconds(CAST(promo.end_date as Uint32))   as end_date\nFROM `//home/market/production/indexer/stratocaster/promos/collected_promo_details/recent`\nWHERE promo_key IS NOT NULL\n  AND DateTime::FromSeconds(CAST (promo.end_date as Uint32)) >= $cur_date;\n\n$offers =\nSELECT DISTINCT o.shop_sku,\n                o.warehouse_id,\n                promo_md5\nFROM `//home/market/production/indexer/stratocaster/offers/recent` as o\n    FLATTEN BY (Yson::ConvertToStringList(Yson::From(CAST(o.binary_promos_md5_base64 AS Json), Yson::Options(false as Strict)), Yson::Options(false as Strict)) as promo_md5)\nWHERE o.warehouse_id IS NOT NULL\n  AND o.shop_sku IS NOT NULL\n  AND o.binary_promos_md5_base64 IS NOT NULL\n  and Yson::ConvertToStringList(Yson::From(CAST(o.binary_promos_md5_base64 AS Json), Yson::Options(false as Strict)), Yson::Options(false as Strict)) is not null;\n\n$cross =\nSELECT  MIN(p.start_date) as start_date,\n        MIN_BY(p.end_date,p.start_date) as end_date,\n        o.shop_sku as ssku,\n        w.region_id as region_id,\nFROM $p as p\n         INNER JOIN $offers as o ON o.promo_md5 = p.promo_key\n         INNER JOIN `//home/market/production/replenishment/order_planning/latest/intermediate/warehouses` as w ON o.warehouse_id = w.id\nWHERE w.region_id IS NOT NULL\nGROUP BY o.shop_sku, w.region_id;\n\n$dates_result =\nSELECT DISTINCT m.approved_market_sku_id   as msku,\n                c.start_date               as start_date,\n                c.end_date                 as end_date,\n                c.region_id                as region_id\nFROM $cross as c\n         INNER JOIN `//home/market/production/ir/ultra-controller/supplier_to_market_sku` AS m\n                    ON c.ssku = m.shop_sku_id\nWHERE m.approved_market_sku_id > 0;\n\n$result =\nSELECT rl.msku                        as msku,\n       rl.region_id                   as region_id,\n       $date_format(rl.start_date)    as start_date,\n       $date_format(MAX(rr.end_date)) as end_date\nFROM $dates_result AS rl\n         INNER JOIN $dates_result AS rr\n                    ON rl.msku = rr.msku\n                        AND rl.region_id = rr.region_id\nWHERE rr.start_date >= rl.start_date\n  AND rr.start_date <= rl.end_date\n  AND rr.end_date >= rl.end_date\nGROUP BY rl.msku,\n         rl.region_id,\n         rl.start_date;\n\nSELECT *\nFROM $result WHERE (msku = 608388320 OR msku = 101364151768);","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"end_date\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"msku\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"region_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"start_date\",[\"OptionalType\",[\"DataType\",\"String\"]]]]]],\"Data\":[[[\"2099-12-31\"],[\"608388320\"],[\"145\"],[\"2021-08-28\"]],[[\"2099-12-31\"],[\"608388320\"],[\"145\"],[\"2021-10-30\"]],[[\"2022-06-17\"],[\"608388320\"],[\"145\"],[\"2022-06-14\"]],[[\"2099-12-31\"],[\"608388320\"],[\"147\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"608388320\"],[\"147\"],[\"2021-10-30\"]],[[\"2099-12-31\"],[\"608388320\"],[\"301\"],[\"2022-03-18\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-08-31\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-09-05\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-09-07\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-09-12\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-09-28\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-28\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-30\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-11-19\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-12-03\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2022-01-09\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2022-04-13\"]],[[\"2022-05-15\"],[\"101364151768\"],[\"145\"],[\"2022-04-17\"]],[[\"2022-06-17\"],[\"101364151768\"],[\"145\"],[\"2022-06-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-09-02\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-09-07\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-09-10\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-09-17\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-09-17\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-10\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-13\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-18\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-30\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2022-02-08\"]],[[\"2022-04-22\"],[\"101364151768\"],[\"147\"],[\"2022-04-17\"]],[[\"2022-06-17\"],[\"101364151768\"],[\"147\"],[\"2022-06-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"300\"],[\"2021-09-02\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"300\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"300\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"300\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"300\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"300\"],[\"2022-02-08\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"300\"],[\"2022-03-06\"]],[[\"2022-05-31\"],[\"101364151768\"],[\"300\"],[\"2022-03-13\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"301\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"301\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"301\"],[\"2021-11-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"301\"],[\"2021-11-11\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"301\"],[\"2022-01-25\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"301\"],[\"2022-02-17\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"301\"],[\"2022-04-17\"]],[[\"2022-06-17\"],[\"101364151768\"],[\"301\"],[\"2022-06-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"302\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"302\"],[\"2022-02-08\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"303\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"303\"],[\"2021-10-21\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"303\"],[\"2022-04-09\"]],[[\"2099-12-31\"],[\"608388320\"],[\"145\"],[\"2021-09-28\"]],[[\"2099-12-31\"],[\"608388320\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"608388320\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"608388320\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"608388320\"],[\"147\"],[\"2022-04-20\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-08-26\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-08-27\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-08-30\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-09-03\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-09-07\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-09-07\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-09-08\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-09-09\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-09-09\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-09-10\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-09-17\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-09-24\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-09-27\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-09-28\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-10-30\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"145\"],[\"2021-12-10\"]],[[\"2022-04-22\"],[\"101364151768\"],[\"145\"],[\"2022-04-17\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-08-30\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-09-09\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2021-12-03\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"147\"],[\"2022-01-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"300\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"300\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"300\"],[\"2022-01-14\"]],[[\"2022-06-17\"],[\"101364151768\"],[\"300\"],[\"2022-06-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"301\"],[\"2021-09-09\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"301\"],[\"2021-09-10\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"301\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"301\"],[\"2021-10-09\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"301\"],[\"2021-10-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"301\"],[\"2021-12-03\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"301\"],[\"2021-12-06\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"301\"],[\"2022-01-11\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"301\"],[\"2022-02-08\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"301\"],[\"2022-04-19\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"302\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"302\"],[\"2022-01-12\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"302\"],[\"2022-02-06\"]],[[\"2022-06-17\"],[\"101364151768\"],[\"302\"],[\"2022-06-14\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"303\"],[\"2021-10-01\"]],[[\"2099-12-31\"],[\"101364151768\"],[\"303\"],[\"2021-10-11\"]],[[\"2022-06-17\"],[\"101364151768\"],[\"303\"],[\"2022-06-14\"]]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"61\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62616865bab793fcd30ba808\",\"issues\":[{\"code\":1070,\"column\":0,\"file\":\"<main>\",\"issues\":[{\"code\":0,\"column\":0,\"file\":\"<main>\",\"issues\":[],\"message\":\"DQ cannot execute the query. Cause: dynamic table\",\"row\":0,\"severity\":\"S_INFO\"}],\"message\":\"Optimization\",\"row\":0,\"severity\":\"S_INFO\"}],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-04-21T14:50:16.130Z\",\"version\":1000000}","type":"YQL_QUERY"},{"cacheKey":null,"base64Value":null,"type":"YT_DATA"}]