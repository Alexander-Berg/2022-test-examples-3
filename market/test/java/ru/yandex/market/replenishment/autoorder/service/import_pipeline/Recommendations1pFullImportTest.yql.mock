[{"hashKey":"fedc359c6ee2afa96b62b68cc77be7e8","query":"USE hahn; PRAGMA yt.InferSchema = '1';\nPRAGMA yson.DisableStrict;\nPRAGMA AnsiInForEmptyOrNullableItemsCollections;\nPRAGMA yt.Pool = 'default';\n\n$stocks = (\n    select\n        st.msku as msku,\n        sum_if(st.fit, s.supplier_type = 1) as count_1p,\n        sum(st.fit) as count_overall\n    from `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/stock_alpaca`  with inline as st\n        join `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/suppliers`  with inline as s\n            on st.supplier_id = s.supplier_id\n    where st.msku > 0\n    group by st.msku\n);\n\n$forecasts = (\n    SELECT\n        msku,\n        SUM_IF(f.demand, f.`date` BETWEEN '2020-05-15' AND '2020-05-28') AS sf14d_1p,\n        SUM_IF(f.demand, f.`date` BETWEEN '2020-05-15' AND '2020-06-11') AS sf28d_1p,\n        SUM_IF(f.demand, f.`date` BETWEEN '2020-05-15' AND '2020-07-09') AS sf56d_1p,\n        SUM_IF(f.total_demand, f.`date` BETWEEN '2020-05-15' AND '2020-05-28') AS sf14d,\n        SUM_IF(f.total_demand, f.`date` BETWEEN '2020-05-15' AND '2020-06-11') AS sf28d,\n        SUM_IF(f.total_demand, f.`date` BETWEEN '2020-05-15' AND '2020-07-09') AS sf56d,\n    FROM `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/forecast_region`  with inline AS f\n    GROUP BY msku\n);\n\nselect\n    r.msku as msku,\n    some(coalesce(st.count_1p, 0)) as stock_1p,\n    some(coalesce(st.count_overall, 0)) as stock_overall,\n    some(ff.sf14d_1p) as sf14d_1p,\n    some(ff.sf28d_1p) as sf28d_1p,\n    some(ff.sf56d_1p) as sf56d_1p,\n    some(ff.sf14d) as sf14d,\n    some(ff.sf28d) as sf28d,\n    some(ff.sf56d) as sf56d\nfrom `/home/market/production/replenishment/order_planning/2020-05-15/outputs/recommendations`  with inline as r\n    left join $stocks as st\n        on r.msku = st.msku\n    left join $forecasts as ff\n        on r.msku = ff.msku\ngroup by r.msku;\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"msku\",[\"DataType\",\"Int64\"]],[\"stock_1p\",[\"DataType\",\"Int64\"]],[\"stock_overall\",[\"DataType\",\"Int64\"]],[\"sf14d_1p\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf28d_1p\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf56d_1p\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf14d\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf28d\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf56d\",[\"OptionalType\",[\"DataType\",\"Double\"]]]]]],\"Data\":[[\"123\",\"195\",\"195\",[\"4.48\"],[\"5.710000000000001\"],[\"5.710000000000001\"],[\"12.63950530999494\"],[\"14.63950530999494\"],[\"14.63950530999494\"]],[\"234\",\"96\",\"96\",[\"4.48\"],[\"5.710000000000001\"],[\"5.710000000000001\"],[\"5.6395053099949415\"],[\"6.428505309994941\"],[\"6.428505309994941\"]],[\"567\",\"0\",\"0\",null,null,null,null,null,null]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"31\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62c6f207054af0b5790e1739\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-07-07T14:48:34.434Z\",\"version\":1000000}","type":"YQL_QUERY"},{"hashKey":"fedc359c6ee2afa96b62b68cc77be7e8","query":"USE hahn; PRAGMA AnsiInForEmptyOrNullableItemsCollections;\n\n$used_mskus = (select distinct r.msku\n    from `/home/market/production/replenishment/order_planning/2020-05-15/outputs/recommendations`  with inline as r\n    where r.msku IS NOT NULL\n);\n\nselect mi.msku as msku,\n       some(mi.supplier_lifetime) as supplier_lifetime,\n       some(mi.in_lifetime) as in_lifetime,\n       some(mi.out_lifetime) as out_lifetime\nfrom `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/msku_info`  with inline as mi\n    INNER JOIN $used_mskus as um ON mi.msku = um.msku\ngroup by mi.msku;\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"msku\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"supplier_lifetime\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"in_lifetime\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"out_lifetime\",[\"OptionalType\",[\"DataType\",\"Int64\"]]]]]],\"Data\":[[[\"123\"],[\"5\"],[\"6\"],[\"7\"]],[[\"234\"],[\"80\"],[\"90\"],[\"100\"]]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"8\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62c6f56bbab7931d11fc0aac\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-07-07T15:03:14.285Z\",\"version\":1000000}","type":"YQL_QUERY"},{"hashKey":"fedc359c6ee2afa96b62b68cc77be7e8","query":"USE hahn; \n        $osg_not_group = (\n            SELECT\n                SUBSTRING(TableName(),0,10) as `date`,\n                CAST(SUBSTRING(TableName(),11,2) AS INT64) / 4 as `qhour`,\n                `market_sku`,\n                `optimal_price`,\n                `warehouse_id`\n            FROM\n        RANGE (\n`/home/market/production/monetize/dynamic_pricing/expiring_goods/expiring_prices`,\n'2020-02-15T00:00:00',\n'2020-05-15T00:00:00'\n)\n        );\n\n        $osg = (\n            SELECT\n                `date`,\n                `qhour`,\n                `market_sku`,\n                MAX(`optimal_price`) AS `optimal_price`,\n                `warehouse_id`\n            FROM $osg_not_group\n        GROUP BY `date`,\n        `qhour`,\n        `market_sku`,\n        `warehouse_id`\n        );\n\n        $is_1P = ($supplier_id) -> { return $supplier_id == 465852};\n\n        $sales = (\n            SELECT\n                COALESCE(sku_transitions.new_entity_id, sales.market_sku) as market_sku,\n                sales.warehouse_id as warehouse_id,\n                sales.partner_id as supplier_id,\n                IF($is_1P(sales.partner_id), 1, 3) as supplier_type,\n                SUBSTRING(orders.creation_date, 0, 10) as `date`,\n                item_count,\n                orders.buyer_region_id as order_buyer_region_id\n            FROM RANGE (\n`/home/market/production/mstat/analyst/regular/cubes_vertica/fact_new_order_item_dict`,\n'2020-02',\n'2020-05'\n)  with inline   as sales\n        JOIN `/home/market/production/mstat/analyst/regular/cubes_vertica/fact_new_order_dict`  with inline as orders\n            ON sales.order_id = orders.id\n        LEFT JOIN\n            \n                `/home/market/production/mstat/analyst/regular/cubes_vertica/fact_new_order_delivery`  with inline\n            \n            as deliveries\n            ON sales.order_id = deliveries.order_id\n        LEFT JOIN `/home/market/production/mstat/dictionaries/shop_real_supplier/latest`  with inline as suppliers\n            ON sales.real_supplier_id = suppliers.rs_id\n        LEFT JOIN `/home/market/production/mstat/dictionaries/mbo/sku_transitions/latest`  with inline as sku_transitions\n            ON sales.market_sku = sku_transitions.old_entity_id\n        LEFT JOIN $osg as osg\n            ON (osg.market_sku = sales.market_sku AND osg.warehouse_id = sales.warehouse_id\n                    AND osg.`date` = orders.creation_date\n                    AND osg.qhour = CAST(SUBSTRING(orders.creation_datetime,11,2) AS INT64) / 4\n        )\n        WHERE orders.market_fulfilment_flag\n                AND (deliveries.shipment_datetime > '1970-01-01T00:00:00'\n                OR (orders.order_status != 'CANCELLED' AND orders.order_status != 'CANCELLED_WITHOUT_REFUND'))\n                AND DateTime::MakeDate(DateTime::ParseIso8601(orders.creation_date))\n                    BETWEEN Date('2020-02-15') AND Date('2020-05-15')\n                AND (osg.optimal_price IS NULL\n                    OR CAST(sales.fact_gross_items_rub_numeric AS Int64) > osg.optimal_price)\n        );\n\n        SELECT\n            market_sku,\n            warehouse_id,\n            order_buyer_region_id,\n            supplier_id,\n            `date`,\n            coalesce(sum_if(item_count, supplier_type = 1), 0) as sales_1p,\n            coalesce(sum(item_count), 0) as sales_all\n        FROM $sales\n        GROUP BY market_sku, warehouse_id, supplier_id, order_buyer_region_id, `date`\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"market_sku\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"warehouse_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"order_buyer_region_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"supplier_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"date\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"sales_1p\",[\"DataType\",\"Int64\"]],[\"sales_all\",[\"DataType\",\"Int64\"]]]]],\"Data\":[[[\"107981\"],[\"145\"],[\"1\"],[\"465852\"],[\"2020-05-10\"],\"1\",\"1\"],[[\"107981\"],[\"145\"],[\"1\"],[\"465852\"],[\"2020-05-14\"],\"1\",\"1\"]]}],\"Position\":{\"Column\":\"9\",\"Row\":\"73\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62c6f2f7d2706c22a7712ea0\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-07-07T14:58:51.789Z\",\"version\":1000000}","type":"YQL_QUERY"},{"hashKey":"fedc359c6ee2afa96b62b68cc77be7e8","query":"USE hahn; select CAST(market_sku AS Int64)   as market_sku,\n       CAST(warehouse_id AS Int64) as warehouse_id\nfrom `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/regional_assortment`  with inline as ra\n    LEFT JOIN `/home/market/production/mstat/dictionaries/mbo/sku_transitions/latest`  with inline as sku_transitions\nON ra.msku = sku_transitions.old_entity_id\ngroup by COALESCE (sku_transitions.new_entity_id, ra.msku) as market_sku, ra.warehouse_id as warehouse_id;\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"market_sku\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"warehouse_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]]]]],\"Data\":[[[\"101\"],[\"1\"]],[[\"101\"],[\"2\"]],[[\"2\"],[\"1\"]],[[\"3\"],[\"3\"]]]}],\"Position\":{\"Column\":\"11\",\"Row\":\"1\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62c6f79c054af0b5790e1c9e\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-07-07T15:12:05.425Z\",\"version\":1000000}","type":"YQL_QUERY"},{"hashKey":"fedc359c6ee2afa96b62b68cc77be7e8","query":"USE hahn; SELECT\n    msku              as msku,\n    warehouse_id      as warehouse_id,\n    `date`            as delivery_date,\n    supplier_id       as supplier_id,\n    actual            as actual,\n    ax_id             as ax_id,\n    ff_id             as ff_id,\n    in_transit        as in_transit,\n    is_xdoc           as is_xdoc,\n    `type`              as type,\n    ff_status         as ff_status,\n    xdoc_status       as xdoc_status,\n    xdoc_date         as xdoc_date,\n    supplier_sl       as supplier_sl,\n    in_transit_sl     as in_transit_sl,\n    comment           as comment\nFROM `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/transits_raw`  with inline\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"msku\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"warehouse_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"delivery_date\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"supplier_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"actual\",[\"OptionalType\",[\"DataType\",\"Bool\"]]],[\"ax_id\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"ff_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"in_transit\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"is_xdoc\",[\"OptionalType\",[\"DataType\",\"Bool\"]]],[\"type\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"ff_status\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"xdoc_status\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"xdoc_date\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"supplier_sl\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"in_transit_sl\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"comment\",[\"OptionalType\",[\"DataType\",\"String\"]]]]]],\"Data\":[[[\"123\"],[\"145\"],[\"2020-05-14\"],[\"566631\"],[true],null,null,[\"10\"],[false],[\"normal\"],null,null,null,null,null,null],[[\"234\"],[\"145\"],[\"2020-05-14\"],[\"566631\"],[true],null,null,[\"11\"],[false],[\"normal\"],null,null,null,null,null,null],[[\"234\"],[\"147\"],[\"2020-05-14\"],[\"566631\"],[true],null,null,[\"5\"],[false],[\"specific\"],null,null,null,null,null,null]]}],\"Position\":{\"Column\":\"11\",\"Row\":\"1\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62c6fd29bab7931d11fc1c7b\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-07-07T15:36:59.940Z\",\"version\":1000000}","type":"YQL_QUERY"},{"hashKey":"fedc359c6ee2afa96b62b68cc77be7e8","query":"USE hahn; PRAGMA yt.InferSchema = '1';\nPRAGMA yson.DisableStrict;\nPRAGMA AnsiInForEmptyOrNullableItemsCollections;\nPRAGMA yt.Pool = 'default';\n\n$is_moscow = ($warehouse_id) -> {\n   return $warehouse_id in (145, 171, 172);\n};\n\n$near_stock = ($w_id, $stock, $m_stock) -> {\n   return\n      case when $is_moscow($w_id) then\n        coalesce($m_stock, 0) - coalesce($stock, 0)\n      else\n        null end;\n};\n\n$transit = (\n    select\n        t.msku as msku,\n        t.warehouse_id as warehouse_id,\n        sum_if(t.in_transit, s.supplier_type = 1) as transit1p,\n        sum(t.in_transit) as transit\n    from\n        `/home/market/production/replenishment/order_planning/2020-05-15/outputs/transits`  with inline as t\n        join `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/suppliers`  with inline as s\n            on t.supplier_id = s.supplier_id\n    group by t.msku, t.warehouse_id);\n\n-- стоки\n$stocks = (\n    select\n        st.msku as msku,\n        st.warehouse_id as warehouse_id,\n        sum_if(st.fit, s.supplier_type = 1) as count_1p,\n        sum(st.fit) as count_overall\n    from `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/stock_alpaca`  with inline as st\n        join `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/suppliers`  with inline as s\n            on st.supplier_id = s.supplier_id\n    where st.msku > 0\n    group by st.msku, st.warehouse_id\n);\n\n-- стоки московских складов\n$moscow_stocks = (\n    select\n        st.msku as msku,\n        sum_if(st.fit, s.supplier_type = 1) as count_1p,\n        sum(st.fit) as count_overall\n    from `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/stock_alpaca`  with inline as st\n        join `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/suppliers`  with inline as s\n            on st.supplier_id = s.supplier_id\n    where st.msku > 0\n        and $is_moscow(st.warehouse_id)\n    group by st.msku\n);\n\nselect\n    r.warehouse_id as warehouse_id,\n    r.msku as msku,\n    some(t.transit1p) as transit1p,\n    some(t.transit) as transit,\n    some(coalesce(st.count_1p, 0)) as stock_1p,\n    some(coalesce(st.count_overall, 0)) as stock_overall,\n    some($near_stock(r.warehouse_id, st.count_1p, m_st.count_1p)) as near_stock_1p,\n    some($near_stock(r.warehouse_id, st.count_overall, m_st.count_overall)) as near_stock_overall\nfrom `/home/market/production/replenishment/order_planning/2020-05-15/outputs/recommendations`  with inline as r\n    left join $transit as t\n        on r.msku = t.msku and r.warehouse_id = t.warehouse_id\n    left join $stocks as st\n        on r.msku = st.msku and r.warehouse_id = st.warehouse_id\n    left join $moscow_stocks as m_st\n        on r.msku = m_st.msku\ngroup by r.msku, r.warehouse_id;\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"warehouse_id\",[\"DataType\",\"Int64\"]],[\"msku\",[\"DataType\",\"Int64\"]],[\"transit1p\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"transit\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"stock_1p\",[\"DataType\",\"Int64\"]],[\"stock_overall\",[\"DataType\",\"Int64\"]],[\"near_stock_1p\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"near_stock_overall\",[\"OptionalType\",[\"DataType\",\"Int64\"]]]]]],\"Data\":[[\"145\",\"123\",[\"10\"],[\"10\"],\"95\",\"95\",[\"0\"],[\"0\"]],[\"145\",\"234\",[\"11\"],[\"11\"],\"96\",\"96\",[\"0\"],[\"0\"]],[\"145\",\"567\",null,null,\"0\",\"0\",[\"0\"],[\"0\"]]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"58\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62c6f08d054af0b5790e15cf\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-07-07T14:42:05.514Z\",\"version\":1000000}","type":"YQL_QUERY"},{"hashKey":"fedc359c6ee2afa96b62b68cc77be7e8","query":"USE hahn; select\n    warehouse_id  AS warehouse_id,\n    `date`        AS supply_date,\n    supplier_type AS supply_type,\n    min(`limit`)       AS items_left,\n    min(limit_prior)   AS items_limit\nfrom `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/delivery_limit_groups`  with inline\nWHERE `limit` > 0 OR limit_prior > 0\nGROUP BY warehouse_id, `date`,supplier_type\nHAVING count(*) = 1\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"warehouse_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"supply_date\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"supply_type\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"items_left\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"items_limit\",[\"OptionalType\",[\"DataType\",\"Int64\"]]]]]],\"Data\":[[[\"145\"],[\"2021-08-17\"],[\"1\"],[\"1\"],[\"1\"]],[[\"145\"],[\"2021-08-17\"],[\"3\"],[\"1\"],[\"1\"]],[[\"147\"],[\"2021-08-17\"],[\"3\"],[\"1\"],[\"4\"]]]}],\"Position\":{\"Column\":\"11\",\"Row\":\"1\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62c6fbb5ae4e0f7481c83a11\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-07-07T15:29:25.037Z\",\"version\":1000000}","type":"YQL_QUERY"},{"hashKey":"fedc359c6ee2afa96b62b68cc77be7e8","query":"USE hahn; PRAGMA AnsiInForEmptyOrNullableItemsCollections;\n\n-- Вынос функций нужен потому, что если их инлайнить, они будут пересоздаваться\n-- на каждой итерации листмапа, а данных у нас немало\n$get_stock = ($data) -> {\n    return $data.0;\n};\n\n$get_expiry = ($data) -> {\n    return $data.1;\n};\n\n-- Стоки с ОСГ\n$known_stocks = (\n    SELECT\n        AGGREGATE_LIST(AsTuple(s.fit, CAST(s.lifetime AS Int32)))                               AS expiry_list_all,\n        AGGREGATE_LIST(if(sup.supplier_type = 1, AsTuple(s.fit, CAST(s.lifetime AS Int32))))    AS expiry_list_1p,\n        s.msku                                                                                  AS msku,\n        w.region_id                                                                             AS warehouse_region_id\n    FROM `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/stock_with_lifetime`  with inline AS s\n        LEFT JOIN `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/warehouses`  with inline AS w ON w.id = s.warehouse_id\n        LEFT JOIN ANY `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/suppliers`  with inline  AS sup ON sup.supplier_id = s.supplier_id\n    WHERE s.msku IS NOT NULL AND msku > 0\n        AND w.region_id IS NOT NULL AND w.region_id > 0\n    GROUP BY s.msku, w.region_id\n);\n\nSELECT\n    ToBytes(Yson::SerializeJson(Yson::From(ListMap(expiry_list_1p,  $get_stock))))  AS stocks_list_1p,\n    ToBytes(Yson::SerializeJson(Yson::From(ListMap(expiry_list_all, $get_stock))))  AS stocks_list_all,\n    ToBytes(Yson::SerializeJson(Yson::From(ListMap(expiry_list_1p,  $get_expiry)))) AS lifetimes_list_1p,\n    ToBytes(Yson::SerializeJson(Yson::From(ListMap(expiry_list_all, $get_expiry)))) AS lifetimes_list_all,\n    msku                                                                            AS msku,\n    warehouse_region_id                                                             AS warehouse_region_id\nFROM $known_stocks;\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"stocks_list_1p\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"stocks_list_all\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"lifetimes_list_1p\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"lifetimes_list_all\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"msku\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"warehouse_region_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]]]]],\"Data\":[[[\"[]\"],[\"[8]\"],[\"[]\"],[\"[10]\"],[\"123\"],[\"145\"]],[[\"[]\"],[\"[45]\"],[\"[]\"],[\"[null]\"],[\"234\"],[\"145\"]]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"28\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62c6f90497c5b754276bf341\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-07-07T15:19:04.010Z\",\"version\":1000000}","type":"YQL_QUERY"},{"hashKey":"fedc359c6ee2afa96b62b68cc77be7e8","query":"USE hahn; PRAGMA yt.InferSchema = '1';\nPRAGMA yson.DisableStrict;\nPRAGMA AnsiInForEmptyOrNullableItemsCollections;\nPRAGMA yt.Pool = 'default';\n\n-- склады\n$warehouses_with_regions = (\n    select\n        wh.id as id,\n        wh.region_id as region_id\n    from `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/warehouses`  with inline as wh\n);\n\n--сейфти сток\n$safety_stocks_by_region = (\n    SELECT\n        s.msku                              AS msku,\n        s.region                            AS region,\n        s.safety_stock                      AS safety_stock,\n        s.`date`                            AS `date`\n    FROM `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/ss_region_reduced`  with inline AS s\n);\n\n--safety stock по стране\n$safety_stocks_country_wide = (\n    SELECT\n        s.msku                              AS msku,\n        SUM(s.safety_stock)                 AS safety_stock,\n        s.`date`                            AS `date`\n    FROM `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/ss_region_reduced`  with inline AS s\n    GROUP BY s.msku, s.`date`\n);\n\n--ручной сток\n$manual_stocks = (\n    select\n       msku, region, max_items, max_items_by_days, min_items, min_items_by_days, `date`\n    from `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/manual_stock_model`  with inline\n);\n\nselect\n    r.lead_time as delivery_time,\n    r.`date` as delivery_date,\n    r.order_date as order_date,\n    r.xdoc_date as xdoc_date,\n    r.warehouse_id as warehouse_id,\n    WeakField(r.warehouse_id_from, Int64) as warehouse_id_from,\n    r.supplier_id as supplier_id,\n    r.qty as purch_qty,\n    WeakField(r.distr_demand, Int64, 0) as distr_demand,\n    r.msku as msku,\n    r.min_shipment as min_shipment,\n    r.shipment_quantum as shipment_quantum,\n    r.delivery_type as supply_route,\n    r.ssku as ssku,\n    WeakField(r.has_cheaper, Bool, false) as has_cheaper_recommendation,\n    case when WeakField(r.distr_demand, Int64, 0) > 0 then\n        Math::Round(ss_country.safety_stock, -1)\n    else\n        Math::Round(ss_region_reduced.safety_stock, -1)\n    end as safety_stock,\n    ms.max_items as max_items,\n    ms.max_items_by_days as max_items_by_days,\n    ms.min_items as min_items,\n    ms.min_items_by_days as min_items_by_days,\n    r.post_opt_comment as reason_of_recommendation,\n    r.inactive as inactive,\n    r.inactive_reason as inactive_reason\nfrom `/home/market/production/replenishment/order_planning/2020-05-15/outputs/recommendations`  with inline as r\n    left join $warehouses_with_regions as wwr\non r.warehouse_id = wwr.id\n    left join $safety_stocks_by_region as ss_region_reduced\non r.msku = ss_region_reduced.msku\n        and wwr.region_id = ss_region_reduced.region\n        and r.`date` = ss_region_reduced.`date`\n    left join $safety_stocks_country_wide as ss_country\non r.msku = ss_country.msku and r.`date` = ss_country.`date`\n    left join $manual_stocks as ms\non r.msku = ms.msku and wwr.region_id = ms.region and r.`date` = ms.`date`\nwhere\n    delivery_type != 'inter-warehouse movement'\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"delivery_time\",[\"DataType\",\"Int64\"]],[\"delivery_date\",[\"DataType\",\"String\"]],[\"order_date\",[\"DataType\",\"String\"]],[\"xdoc_date\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"warehouse_id\",[\"DataType\",\"Int64\"]],[\"warehouse_id_from\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"supplier_id\",[\"DataType\",\"Int64\"]],[\"purch_qty\",[\"DataType\",\"Int64\"]],[\"distr_demand\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"msku\",[\"DataType\",\"Int64\"]],[\"min_shipment\",[\"DataType\",\"Int64\"]],[\"shipment_quantum\",[\"DataType\",\"Int64\"]],[\"supply_route\",[\"DataType\",\"String\"]],[\"ssku\",[\"DataType\",\"String\"]],[\"has_cheaper_recommendation\",[\"OptionalType\",[\"DataType\",\"Bool\"]]],[\"safety_stock\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"max_items\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"max_items_by_days\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"min_items\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"min_items_by_days\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"reason_of_recommendation\",[\"DataType\",\"String\"]],[\"inactive\",[\"DataType\",\"Bool\"]],[\"inactive_reason\",[\"DataType\",\"String\"]]]]],\"Data\":[[\"4\",\"2020-05-25\",\"2020-05-21\",null,\"145\",[\"123\"],\"566631\",\"0\",[\"0\"],\"123\",\"10\",\"10\",\"direct\",\"004000.10000\",[false],[\"1.8\"],null,[\"39.29002695744109\"],null,[\"29.46752021808082\"],\"comment\",false,\"\"],[\"4\",\"2020-05-29\",\"2020-05-22\",null,\"145\",[\"123\"],\"566631\",\"2\",[\"0\"],\"123\",\"10\",\"10\",\"direct\",\"004000.20000\",[false],[\"1.2\"],null,[\"39.29002695744109\"],null,[\"29.46752021808082\"],\"comment\",false,\"\"],[\"4\",\"2020-06-05\",\"2020-06-02\",[\"2020-06-04\"],\"145\",[\"123\"],\"566631\",\"4\",[\"2\"],\"234\",\"10\",\"10\",\"xdoc\",\"004000.30000\",[false],[\"6.9\"],null,null,null,null,\"comment\",false,\"\"],[\"4\",\"2020-05-24\",\"2020-05-23\",null,\"145\",[\"123\"],\"566631\",\"0\",[\"0\"],\"234\",\"10\",\"10\",\"direct\",\"004000.10000\",[false],[\"2.4\"],null,[\"39.29002695744109\"],null,[\"29.46752021808082\"],\"comment\",false,\"\"],[\"4\",\"2020-05-25\",\"2020-05-21\",null,\"145\",[\"123\"],\"566631\",\"0\",[\"0\"],\"567\",\"10\",\"10\",\"direct\",\"000124.777\",[false],null,null,null,null,null,\"comment\",false,\"\"],[\"4\",\"2020-06-05\",\"2020-06-01\",null,\"145\",[\"123\"],\"566631\",\"4\",[\"2\"],\"123\",\"10\",\"10\",\"direct\",\"004000.30000\",[false],[\"4.9\"],null,null,null,null,\"comment\",true,\"inactive comment\"],[\"4\",\"2020-05-28\",\"2020-05-24\",null,\"145\",[\"123\"],\"566631\",\"2\",[\"0\"],\"234\",\"10\",\"10\",\"direct\",\"004000.20000\",[false],[\"2.1\"],null,[\"39.29002695744109\"],null,[\"29.46752021808082\"],\"comment\",false,\"\"]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"41\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62c6ee1bbab7931d11fbf9fc\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-07-07T14:31:47.052Z\",\"version\":1000000}","type":"YQL_QUERY"},{"hashKey":"fedc359c6ee2afa96b62b68cc77be7e8","query":"USE hahn; PRAGMA yt.InferSchema = '1';\nPRAGMA yson.DisableStrict;\nPRAGMA AnsiInForEmptyOrNullableItemsCollections;\nPRAGMA yt.Pool = 'default';\n\n$fullfilment_partners = (\n    SELECT id\n        FROM `/home/market/production/mbi/dictionaries/partner_biz_snapshot/latest`  with inline\n    WHERE is_fullfilment = 1\n);\n\n$warehouses_with_regions = (\n    select\n        wh.id as id,\n        wh.region_id as region_id\n    from `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/warehouses`  with inline as wh\n);\n\n$forecasts = (\n    SELECT\n        msku,\n        region,\n        SUM_IF(f.demand, f.`date` BETWEEN '2020-05-15' AND '2020-05-28') AS sf14d_1p,\n        SUM_IF(f.demand, f.`date` BETWEEN '2020-05-15' AND '2020-06-11') AS sf28d_1p,\n        SUM_IF(f.demand, f.`date` BETWEEN '2020-05-15' AND '2020-07-09') AS sf56d_1p,\n        SUM_IF(f.total_demand, f.`date` BETWEEN '2020-05-15' AND '2020-05-28') AS sf14d,\n        SUM_IF(f.total_demand, f.`date` BETWEEN '2020-05-15' AND '2020-06-11') AS sf28d,\n        SUM_IF(f.total_demand, f.`date` BETWEEN '2020-05-15' AND '2020-07-09') AS sf56d,\n    FROM `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/forecast_region`  with inline AS f\n    LEFT JOIN `/home/market/production/mstat/dictionaries/mbo/sku_transitions/latest`  with inline AS sku_transitions\n        ON f.msku = sku_transitions.old_entity_id\n    GROUP BY COALESCE(sku_transitions.new_entity_id, f.msku) as msku, f.region AS region\n);\n\n$oos_by_region_and_dates = (\n    select\n        msku,\n        region,\n        CAST(s.`date` as Date) as `date`,\n        sum(s.missed_orders) as missed_orders,\n        sum_if(s.missed_orders, sup.supplier_type = 1) as missed_orders_1p\n    from `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/suppliers_demand`  with inline as s\n        inner join `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/warehouses`  with inline as w\n        on w.id = s.warehouse_id\n        left join any `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/suppliers`  with inline as sup\n        on sup.supplier_id = s.supplier_id\n    where s.supplier_id > 0 AND s.supplier_id IN $fullfilment_partners\n    group by s.msku as msku, s.`date`, w.region_id as region\n    having not bool_or(s.on_stock)\n);\n\n$oos_by_region = (\n    SELECT\n        msku,\n        region,\n        sum_if(cast(missed_orders as double), `date` between Date('2020-04-16') and Date('2020-05-14')) as missed_orders_28d,\n        sum_if(cast(missed_orders_1p as double), `date` between Date('2020-04-16') and Date('2020-05-14')) as missed_orders_28d_1p,\n        sum(cast(missed_orders as double)) as missed_orders_56d,\n        sum(cast(missed_orders_1p as double)) as missed_orders_56d_1p,\n        count_if(`date` between CAST('2020-04-16' as Date) and CAST('2020-05-14' as Date)) as oos_28_days,\n        count(1) as oos_days\n    FROM $oos_by_region_and_dates\n    GROUP BY msku, region\n);\n\n$oos = (\n    select\n        coalesce(sku_transitions.new_entity_id, oos.msku) as msku,\n        region,\n        oos_28_days,\n        oos_days,\n        missed_orders_28d,\n        missed_orders_56d,\n        missed_orders_28d_1p,\n        missed_orders_56d_1p\n    FROM $oos_by_region as oos\n        left join `/home/market/production/mstat/dictionaries/mbo/sku_transitions/latest`  with inline as sku_transitions\n        on oos.msku = sku_transitions.old_entity_id\n);\n\n$actual_fit = (\n     SELECT\n         msku,\n         region_id,\n         fit\n     FROM `/home/market/testing/replenishment/autoorder/import_preparation/actual_fit/2020-05-15`  with inline\n);\n\n$transit = (\n    select\n        msku,\n        region,\n        sum_if(in_transit, s.supplier_type = 1) as transit1p,\n        sum(in_transit) as transit\n    from\n        `/home/market/production/replenishment/order_planning/2020-05-15/outputs/transits`  with inline as t\n    join `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/suppliers`  with inline as s\n            on t.supplier_id = s.supplier_id\n    left join $warehouses_with_regions AS wwr ON t.warehouse_id = wwr.id\n    left join `/home/market/production/mstat/dictionaries/mbo/sku_transitions/latest`  with inline as sku_transitions\n            on t.msku = sku_transitions.old_entity_id\n\n    group by coalesce(sku_transitions.new_entity_id, t.msku) as msku, wwr.region_id as region\n);\n\n$stocks = (\n    select\n        msku,\n        region,\n        sum_if(st.fit, s.supplier_type = 1) as count_1p,\n        sum(st.fit) as count_overall\n    from `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/stock_alpaca`  with inline as st\n        join `/home/market/production/replenishment/order_planning/2020-05-15/intermediate/suppliers`  with inline as s\n            on st.supplier_id = s.supplier_id\n        left join $warehouses_with_regions AS wwr\n            on st.warehouse_id = wwr.id\n        left join `/home/market/production/mstat/dictionaries/mbo/sku_transitions/latest`  with inline as sku_transitions\n            on st.msku = sku_transitions.old_entity_id\n    where st.msku > 0\n    group by coalesce(sku_transitions.new_entity_id, st.msku) as msku, wwr.region_id as region\n);\n\n$recommendations = (\n    select\n        coalesce(sku_transitions.new_entity_id, rec.msku) as msku,\n        rec.warehouse_id as warehouse_id\n    from `/home/market/production/replenishment/order_planning/2020-05-15/outputs/recommendations`  with inline as rec\n    left join `/home/market/production/mstat/dictionaries/mbo/sku_transitions/latest`  with inline as sku_transitions\n            on rec.msku = sku_transitions.old_entity_id\n);\n\nselect\n    r.msku as msku,\n    wwr.region_id as region,\n    some(ff.sf14d_1p) as sf14d_1p,\n    some(ff.sf28d_1p) as sf28d_1p,\n    some(ff.sf56d_1p) as sf56d_1p,\n    some(ff.sf14d) as sf14d,\n    some(ff.sf28d) as sf28d,\n    some(ff.sf56d) as sf56d,\n    some(coalesce(oos.oos_28_days, 0)) as oos_28_days,\n    some(coalesce(oos.oos_days, 0)) as oos_days,\n    some(coalesce(oos.missed_orders_28d, 0)) as missed_orders_28d,\n    some(coalesce(oos.missed_orders_56d, 0)) as missed_orders,\n    some(coalesce(oos.missed_orders_28d_1p, 0)) as missed_orders_28d_1p,\n    some(coalesce(oos.missed_orders_56d_1p, 0)) as missed_orders_1p,\n    some(coalesce(act_fit.fit, 0)) as actual_fit,\n    some(t.transit1p) as transit1p,\n    some(t.transit) as transit,\n    some(coalesce(st.count_1p, 0)) as stock_1p,\n    some(coalesce(st.count_overall, 0)) as stock_overall\nfrom $recommendations as r\n    left join $warehouses_with_regions AS wwr\n        on r.warehouse_id = wwr.id\n    left join $forecasts as ff\n        on r.msku = ff.msku and wwr.region_id = ff.region\n    left join $oos as oos\n        on r.msku = oos.msku and wwr.region_id = oos.region\n    left join $actual_fit as act_fit\n        on r.msku = act_fit.msku and wwr.region_id = act_fit.region_id\n    left join $transit as t\n        on r.msku = t.msku and wwr.region_id = t.region\n    left join $stocks as st\n        on r.msku = st.msku and wwr.region_id = st.region\nwhere\n    ff.msku is not null or\n    oos.msku is not null or\n    act_fit.msku is not null or\n    t.msku is not null or\n    st.msku is not null\ngroup by r.msku, wwr.region_id;\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"msku\",[\"DataType\",\"Int64\"]],[\"region\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"sf14d_1p\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf28d_1p\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf56d_1p\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf14d\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf28d\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf56d\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"oos_28_days\",[\"DataType\",\"Uint64\"]],[\"oos_days\",[\"DataType\",\"Uint64\"]],[\"missed_orders_28d\",[\"DataType\",\"Double\"]],[\"missed_orders\",[\"DataType\",\"Double\"]],[\"missed_orders_28d_1p\",[\"DataType\",\"Double\"]],[\"missed_orders_1p\",[\"DataType\",\"Double\"]],[\"actual_fit\",[\"DataType\",\"Int64\"]],[\"transit1p\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"transit\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"stock_1p\",[\"DataType\",\"Int64\"]],[\"stock_overall\",[\"DataType\",\"Int64\"]]]]],\"Data\":[[\"123\",[\"145\"],[\"4.48\"],[\"5.710000000000001\"],[\"5.710000000000001\"],[\"12.63950530999494\"],[\"14.63950530999494\"],[\"14.63950530999494\"],\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"1318\",[\"10\"],[\"10\"],\"95\",\"95\"],[\"234\",[\"145\"],[\"4.48\"],[\"5.710000000000001\"],[\"5.710000000000001\"],[\"5.6395053099949415\"],[\"6.428505309994941\"],[\"6.428505309994941\"],\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"1651\",[\"11\"],[\"11\"],\"96\",\"96\"]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"132\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62d6ae49054af0b0d3c275f6\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-07-19T13:15:51.534Z\",\"version\":1000000}","type":"YQL_QUERY"},{"cacheKey":null,"base64Value":null,"type":"YT_DATA"}]