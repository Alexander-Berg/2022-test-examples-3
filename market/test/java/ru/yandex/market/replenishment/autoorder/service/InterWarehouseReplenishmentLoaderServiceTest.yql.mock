[{"hashKey":"76baf6c175f03fefbbadb6010736761e","query":"USE hahn; PRAGMA yt.InferSchema = '1000';\nPRAGMA AnsiInForEmptyOrNullableItemsCollections;\n\n$warehouses_with_regions = (\n    select\n        wh.id as id,\n        wh.region_id as region_id\n    from `/home/market/production/replenishment/order_planning/2021-06-01/intermediate/warehouses`  with inline as wh\n);\n\n$transit = (\n    SELECT\n        msku,\n        warehouse_id,\n        SUM(in_transit) AS transit\n    FROM `/home/market/production/replenishment/order_planning/2021-06-01/outputs/transits`  with inline\n    GROUP BY msku, warehouse_id\n);\n\n$forecasts = (\n    SELECT\n        msku,\n        region,\n        SUM_IF(f.demand, f.`date` BETWEEN '2021-06-01' AND '2021-06-14') AS sf14d_1p,\n        SUM_IF(f.demand, f.`date` BETWEEN '2021-06-01' AND '2021-06-28') AS sf28d_1p,\n        SUM_IF(f.demand, f.`date` BETWEEN '2021-06-01' AND '2021-07-26') AS sf56d_1p,\n        SUM_IF(f.total_demand, f.`date` BETWEEN '2021-06-01' AND '2021-06-14') AS sf14d,\n        SUM_IF(f.total_demand, f.`date` BETWEEN '2021-06-01' AND '2021-06-28') AS sf28d,\n        SUM_IF(f.total_demand, f.`date` BETWEEN '2021-06-01' AND '2021-07-26') AS sf56d,\n    FROM `/home/market/production/replenishment/order_planning/2021-06-01/intermediate/forecast_region`  with inline AS f\n    GROUP BY msku, f.region AS region\n);\n\n-- стоки\n$stocks = (\n    SELECT\n        m.approved_market_sku_id                    AS msku,\n        s.warehouse_id                              AS warehouse_id,\n        SUM(IF(fit < freezed, 0, fit - freezed))    AS count\n    FROM `/home/market/production/mstat/dictionaries/stock_sku/1d/latest`  with inline AS s\n        LEFT JOIN `/home/market/production/ir/ultra-controller/supplier_to_market_sku`  with inline AS m\n    ON m.shop_sku_id = s.shop_sku AND m.shop_id = s.supplier_id\n    WHERE m.approved_market_sku_id > 0\n    GROUP BY m.approved_market_sku_id, s.warehouse_id\n);\n\n-- каттимы\n$catteams = (\n    SELECT DISTINCT\n        g.market_sku    AS msku,\n        c.catteam       AS catteam\n    FROM `/home/market/production/analytics/business/fulfillment/goods_to_sale/prod/latest`  with inline AS g\n        LEFT JOIN `/home/market/production/mstat/analyst/const/hid_to_category_director/latest`  with inline AS c\n    ON c.hid = g.hid\n    WHERE g.hid > 0\n);\n\n--сейфти сток\n$safety_stocks = (\n    SELECT\n        s.msku                              AS msku,\n        s.region                            AS region,\n        s.safety_stock                      AS safety_stock,\n        s.`date`                            AS `date`\n    FROM `/home/market/production/replenishment/order_planning/2021-06-01/intermediate/ss_region`  with inline AS s\n);\n\nSELECT\n    r.msku                                  AS msku,\n    r.ssku                                  AS ssku,\n    r.supplier_id                           AS supplier_id,\n    r.supplier_type                         AS supplier_type,\n    r.warehouse_id                          AS warehouse_id,\n    WeakField(r.warehouse_id_from, Int64)   AS warehouse_from,\n    c.catteam                               AS catteam,\n    r.`date`                                AS delivery_date,\n    r.lead_time                             AS delivery_time,\n    r.qty                                   AS purch_qty,\n    t_from.transit                          AS transit_from,\n    t_to.transit                            AS transit_to,\n    ff.sf14d_1p                             AS sf14d_1p,\n    ff.sf28d_1p                             AS sf28d_1p,\n    ff.sf56d_1p                             AS sf56d_1p,\n    ff.sf14d                                AS sf14d,\n    ff.sf28d                                AS sf28d,\n    ff.sf56d                                AS sf56d,\n    s_from.count                            AS stock_from,\n    s_to.count                              AS stock_to,\n    Math::Round(ss_from.safety_stock, -1)   AS safety_stock_from,\n    Math::Round(ss_to.safety_stock, -1)     AS safety_stock_to\nFROM `/home/market/production/replenishment/order_planning/2021-06-01/intermediate/inter_wh_movements`  with inline AS r\n    LEFT JOIN $transit AS t_from\nON t_from.msku = r.msku AND t_from.warehouse_id = WeakField(r.warehouse_id_from, Int64)\n    LEFT JOIN $warehouses_with_regions as wwr\non r.warehouse_id = wwr.id\n    LEFT JOIN $warehouses_with_regions as wwr_from\non WeakField(r.warehouse_id_from, Int64) = wwr_from.id\n    LEFT JOIN $transit AS t_to\nON t_to.msku = r.msku AND t_to.warehouse_id = r.warehouse_id\n    LEFT JOIN $forecasts AS ff\nON ff.msku = r.msku AND ff.region = wwr.region_id\n    LEFT JOIN $stocks AS s_from\nON s_from.msku = r.msku AND s_from.warehouse_id = WeakField(r.warehouse_id_from, Int64)\n    LEFT JOIN $stocks AS s_to\nON s_to.msku = r.msku AND s_to.warehouse_id = r.warehouse_id\n    LEFT JOIN $safety_stocks AS ss_from\nON ss_from.msku = r.msku\n    AND ss_from.region = wwr_from.region_id\n    AND ss_from.`date` = r.`date`\n    LEFT JOIN $safety_stocks AS ss_to\nON ss_to.msku = r.msku AND ss_to.region = wwr.region_id AND ss_to.`date` = r.`date`\n    LEFT JOIN $catteams AS c\nON c.msku = r.msku\nWHERE delivery_type = 'inter-warehouse movement';\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"msku\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"ssku\",[\"OptionalType\",[\"DataType\",\"Utf8\"]]],[\"supplier_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"supplier_type\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"warehouse_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"warehouse_from\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"catteam\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"delivery_date\",[\"OptionalType\",[\"DataType\",\"Utf8\"]]],[\"delivery_time\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"purch_qty\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"transit_from\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"transit_to\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"sf14d_1p\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf28d_1p\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf56d_1p\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf14d\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf28d\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"sf56d\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"stock_from\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"stock_to\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"safety_stock_from\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"safety_stock_to\",[\"OptionalType\",[\"DataType\",\"Double\"]]]]]],\"Data\":[[[\"102\"],[\"2\"],[\"2\"],[\"2\"],[\"2\"],[\"2\"],[\"2\"],[\"2021-06-01\"],[\"1\"],[\"2\"],[\"2\"],[\"2\"],[\"1\"],[\"1\"],[\"1\"],[\"2\"],[\"2\"],[\"2\"],null,null,[\"2\"],[\"2\"]],[[\"101\"],[\"1\"],[\"1\"],[\"1\"],[\"1\"],[\"1\"],[\"1\"],[\"2021-06-01\"],[\"1\"],[\"1\"],[\"1\"],[\"1\"],[\"0.5\"],[\"0.5\"],[\"0.5\"],[\"1\"],[\"1\"],[\"1\"],null,null,[\"1\"],[\"1\"]]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"68\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"6290945c054af0a9a2732053\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-05-27T09:07:28.207Z\",\"version\":1000000}","type":"YQL_QUERY"},{"cacheKey":null,"base64Value":null,"type":"YT_DATA"}]