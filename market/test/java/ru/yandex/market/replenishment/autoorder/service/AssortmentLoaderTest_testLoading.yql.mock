[{"hashKey":"d41d8cd98f00b204e9800998ecf8427e","query":"USE hahn; -- WARNING: не нужно оборачивать названия таблиц в tbl()! Тест работает исключительно через кэш YT из файлика\n-- \"AssortmentLoaderTest_testLoading.yql.mock\"\nPRAGMA DisableAnsiInForEmptyOrNullableItemsCollections;\n\n$exctract_date = ($dateString) -> {\n    return DateTime::MakeDate(DateTime::Parse(\"%Y-%m-%d\")(COALESCE($dateString, \"\")));\n};\n\n$fullfilment_partners = (\n    SELECT id\n        FROM `//home/market/production/mbi/dictionaries/partner_biz_snapshot/latest`\n        WHERE is_fullfilment = 1\n);\n\n$msku_with_fullfilment_supplier = (\n    SELECT approved_market_sku_id as msku\n    FROM `//home/market/production/ir/ultra-controller/supplier_to_market_sku`\n    WHERE shop_id in $fullfilment_partners\n);\n\n$abc = (\n    SELECT DISTINCT\n        market_sku as msku,\n    -- Здесь может быть несколько разных abc_gmv за одну дату, выберется случайная\n        MAX_BY(abc_gmv, $exctract_date(`date`)) as abc\n    FROM `//home/market/production/analytics/business/operations/replenishment/abc/total/latest`\n    WHERE `date` is not null\n        AND market_sku IN $msku_with_fullfilment_supplier\n    GROUP BY market_sku\n);\n\n\n$departments = (\n    SELECT\n        msku_msku as msku,\n        some(msku_category_category_directors_category_team) as department_name\n    FROM `//home/market/production/mstat/analyst/regular/cubes_vertica/dim_ssku_flattened`\n    WHERE msku_category_category_directors_category_team != ''\n        AND shop_id IN $fullfilment_partners\n    GROUP BY msku_msku\n);\n\n-- Эта часть вынесена в подзапрос, потому что такой хак магическим образом уменьшает время выгрузки YT с ~ 4,5 минут\n-- до < 3,5 минут\n$assortment = (\n    SELECT\n        model_id    AS msku,\n        title,\n        category_id,\n        CAST(\n            Listhead(\n                ListFilter(data.parameter_values, ($x) -> {\n                    return $x.xsl_name = 'packageNumInSpike'\n                })\n            ).numeric_value\n            as Uint32\n        )           AS package_num_in_spike,\n        Listhead(\n            ListFilter(data.parameter_values, ($c) -> {\n                return $c.xsl_name IN ('cargoType980','cargoType985','cargoType990') AND $c.bool_value\n            })\n        ).xsl_name AS honest_sign,\n        data.modified_ts AS modified_ts\n        FROM `//home/market/production/mbo/export/recent/models/sku`\n        WHERE model_id > 0 AND title != '' AND category_id > 0\n        AND model_id IN $msku_with_fullfilment_supplier\n        );\n\n\n$fact_golden_matrix = (\n    SELECT DISTINCT market_sku  AS msku\n    FROM `//home/market/production/mstat/analyst/regular/cubes_vertica/fact_golden_matrix`\n    WHERE market_sku IS NOT NULL\n        AND market_sku IN $msku_with_fullfilment_supplier\n);\n\n$vendor_and_reserve_title_info = (\n    SELECT\n        o.approved_market_sku_id AS msku,\n        some(if(vendor_id > 0, vendor_id)) as vendor_id,\n        some(if(vendor_code is not null AND vendor_code != '', vendor_code)) as vendor_code,\n        some(if(title is not null AND title != '', title)) as reserve_title\n    FROM `//home/market/production/mbo/stat/mboc_offers_expanded_sku/latest` AS o\n    WHERE o.approved_market_sku_id > 0\n        AND o.supplier_id IN $fullfilment_partners\n    GROUP BY o.approved_market_sku_id\n);\n\nSELECT\n    a.msku                              AS msku,\n    coalesce(a.title, vi.reserve_title) AS title,\n    a.category_id               AS category_id,\n    a.package_num_in_spike      AS package_num_in_spike,\n    a.modified_ts               AS modified_ts,\n    a.honest_sign               AS honest_sign,\n    abc.abc                     AS abc,\n    d.department_name           AS department_name,\n    fgm.msku IS NOT NULL        AS core_fix_matrix,\n    vi.vendor_code              AS vendor_code,\n    vi.vendor_id                AS vendor_id\nFROM $assortment AS a\n    LEFT JOIN $abc AS abc ON abc.msku = a.msku\n    LEFT JOIN $departments AS d ON d.msku = a.msku\n    LEFT JOIN $fact_golden_matrix AS fgm ON fgm.msku = a.msku\n    LEFT JOIN $vendor_and_reserve_title_info AS vi ON vi.msku = a.msku WHERE a.msku IN (100789385728, 100745679993, 100545143950, 14016243, 100548402149, 100545142911, 100490563070, 100367386753, 100964635524, 85845068, 100647632183, 144765324, 100900440976, 277442059, 143465451, 10061161770, 101288276948, 101282719896, 101343854606,101326621186,101669472054);","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"msku\",[\"OptionalType\",[\"DataType\",\"Uint64\"]]],[\"title\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"category_id\",[\"OptionalType\",[\"DataType\",\"Uint64\"]]],[\"package_num_in_spike\",[\"OptionalType\",[\"DataType\",\"Uint32\"]]],[\"modified_ts\",[\"OptionalType\",[\"DataType\",\"Uint64\"]]],[\"honest_sign\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"abc\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"department_name\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"core_fix_matrix\",[\"DataType\",\"Bool\"]],[\"vendor_code\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"vendor_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]]]]],\"Data\":[[[\"85845068\"],[\"Гладильная доска Nika 9 Н9, 122х40 см\"],[\"1564519\"],null,[\"1648504741695\"],null,[\"A\"],[\"Товары для дома\"],true,[\"451064\"],[\"10988316\"]],[[\"277442059\"],[\"Гладильная доска gimi Pisa, 114х33 см\"],[\"1564519\"],null,[\"1648229445802\"],null,[\"D\"],[\"Товары для дома\"],false,[\" 1449000150006\"],[\"8338330\"]],[[\"100367386753\"],[\"Перчатки Vileda универсальные Super Grip, 1 пара, размер L, цвет желтый\"],[\"12943742\"],[\"1\"],[\"1647467579890\"],null,[\"D\"],[\"FMCG\"],false,[\"146097\"],[\"12738640\"]],[[\"100490563070\"],[\"Таблетки для посудомоечной машины Finish All in 1 Max таблетки original, 300 шт. в 3 уп.\"],[\"13196790\"],[\"3\"],[\"1645454850751\"],null,[\"A\"],[\"FMCG\"],true,null,[\"13142418\"]],[[\"100545142911\"],[\"Лакомство для собак Titbit Мюсли Fitness с ягненком и рисом, 640 г (шоу бокс)\"],[\"12718332\"],[\"16\"],[\"1647464519745\"],null,[\"D\"],[\"FMCG\"],true,[\"55362\"],[\"10717254\"]],[[\"100548402149\"],[\"Лакомство для собак Titbit Трюфельдоги с телятиной, 495 г (шоу бокс)\"],[\"12718332\"],[\"15\"],[\"1647453819597\"],null,[\"D\"],[\"FMCG\"],false,[\"52157\"],[\"10717254\"]],[[\"100900440976\"],[\"Верхний душ Ideal STANDARD Ceratherm 100 BD006XC,   хром\"],[\"2190938\"],null,[\"1648148047718\"],null,[\"D\"],[\"DIY & Auto\"],false,[\"BD006XC\"],[\"1629468\"]],[[\"101288276948\"],[\"Пистолет для монтажной пены Bartex Neo CY-091\"],[\"14426509\"],null,[\"1647672296072\"],null,null,[\"DIY & Auto\"],false,[\"317433\"],[\"14471789\"]],[[\"143465451\"],[\"Гладильная доска HAUSMANN VeRa, 125х42 см\"],[\"1564519\"],null,[\"1648229342317\"],null,[\"D\"],[\"Товары для дома\"],false,[\"HM-3175\"],[\"10546875\"]],[[\"144765324\"],[\"Гладильная доска HAUSMANN Complete, 120х38 см\"],[\"1564519\"],null,[\"1648229342317\"],null,[\"B\"],[\"Товары для дома\"],true,[\"HM-2121\"],[\"10546875\"]],[[\"100545143950\"],[\"Лакомство для собак Titbit Мюсли Fitness с телятиной и злаками, 640 г (шоу бокс)\"],[\"12718332\"],[\"16\"],[\"1647468366080\"],null,[\"D\"],[\"FMCG\"],true,[\"55361\"],[\"10717254\"]],[[\"100647632183\"],[\"Гладильная доска Attribute Teflonix, 130х47 см, серая\"],[\"1564519\"],null,[\"1648229432549\"],null,[\"A\"],[\"Товары для дома\"],true,[\"ABT142 Teflonix\"],[\"10713382\"]],[[\"100745679993\"],[\"Гель для стирки Persil Color, 1.95 л, бутылка\"],[\"13041429\"],[\"1\"],[\"1649146254732\"],null,[\"A\"],[\"FMCG\"],true,[\"2454029\"],[\"10716544\"]],[[\"100789385728\"],[\"Таблетки для посудомоечной машины BioMio Bio-total таблетки, 180 шт.\"],[\"13196790\"],[\"6\"],[\"1645442828498\"],null,[\"A\"],[\"FMCG\"],true,null,[\"13136763\"]],[[\"100964635524\"],[\"Стакан одноразовый Комус Стандарт бумажный коричневый 300 мл 25 штук в упаковке\"],[\"1564518\"],null,[\"1638240140882\"],null,[\"D\"],[\"Товары для дома\"],false,null,[\"16644882\"]],[[\"101282719896\"],[\"Uniroyal MS Plus 77 255/55 R18 109V зимняя\"],[\"90490\"],null,[\"1647842214397\"],[\"cargoType980\"],[\"D\"],[\"DIY & Auto\"],false,null,[\"152762\"]]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"89\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"62505108ae4e0f1d0c9fecb1\",\"issues\":[{\"code\":1070,\"column\":0,\"file\":\"<main>\",\"issues\":[{\"code\":0,\"column\":0,\"file\":\"<main>\",\"issues\":[],\"message\":\"DQ cannot execute the query. Cause: dynamic table\",\"row\":0,\"severity\":\"S_INFO\"}],\"message\":\"Optimization\",\"row\":0,\"severity\":\"S_INFO\"}],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-04-08T15:36:12.530Z\",\"version\":1000000}","type":"YQL_QUERY"},{"cacheKey":null,"base64Value":null,"type":"YT_DATA"}]