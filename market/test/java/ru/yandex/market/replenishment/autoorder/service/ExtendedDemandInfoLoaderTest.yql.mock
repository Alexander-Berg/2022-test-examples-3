[{"hashKey":"43644470c6602645f8199650a47c381a","query":"USE hahn; PRAGMA AnsiInForEmptyOrNullableItemsCollections;\n\n$document_states = (\n    SELECT DISTINCT purchid, documentstate\n    FROM `/home/market/production/mstat/dictionaries/axapta_purchases/latest`  with inline\n    WHERE purchid IN ('Зп-000000005', 'Зп-000000011')\n);\n\n$fulfillment_timestamps = (\n    SELECT\n        request_id,\n        MIN(IF(status_name = 'Товары прибыли', updated_at, NULL)) AS fst_updated_at,\n        MIN(IF(status_name = 'Товары оприходованы', updated_at, NULL)) AS snd_updated_at\n    FROM `/home/market/production/mstat/dictionaries/fulfillment_request_status_history/latest`  with inline\n    GROUP BY request_id\n);\n\n$fulfillment_request_items = (\n    SELECT\n        request_id,\n        COUNT(*) AS mskus,\n        SUM(count) AS items,\n        SUM(count * CAST(supply_price AS double)) AS sum\n    FROM `/home/market/production/mstat/dictionaries/fulfillment_request_item/1d/latest`  with inline\n    GROUP BY request_id\n);\n\nSELECT\n    ax.purchid as order_id,\n    ax.documentstate as documentstate,\n    ffsr.status_name as ff_api_status_name,\n    ffsr.service_request_id as service_request_id,\n    ffsr.requested_date as requested_date,\n    ffsr.id as ff_api_request_id,\n    ffsr.items_total_count as items_total_count,\n    ffsr.items_total_fact_count as items_total_fact_count,\n    ffrsh.fst_updated_at as fst_acceptance_at,\n    ffrsh.snd_updated_at as snd_acceptance_at,\n    ffri.mskus as ff_api_mskus,\n    ffri.items as ff_api_items,\n    ffri.sum as ff_api_sum\nFROM $document_states AS ax\nJOIN `/home/market/production/mstat/dictionaries/fulfillment_shop_request/1d/latest`  with inline AS ffsr\n    ON ffsr.external_request_id = ax.purchid\nJOIN $fulfillment_timestamps AS ffrsh\n    ON ffrsh.request_id  = ffsr.id\nJOIN $fulfillment_request_items AS ffri\n    ON ffri.request_id = ffsr.id\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"order_id\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"documentstate\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"ff_api_status_name\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"service_request_id\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"requested_date\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"ff_api_request_id\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"items_total_count\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"items_total_fact_count\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"fst_acceptance_at\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"snd_acceptance_at\",[\"OptionalType\",[\"DataType\",\"String\"]]],[\"ff_api_mskus\",[\"DataType\",\"Uint64\"]],[\"ff_api_items\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"ff_api_sum\",[\"OptionalType\",[\"DataType\",\"Double\"]]]]]],\"Data\":[[[\"Зп-000000005\"],[\"Подтверждено\"],[\"Обработана\"],[\"23005740\"],[\"2019-08-15 00:00:00.0\"],[\"101\"],[\"174\"],[\"174\"],null,[\"2017-11-10 15:51:47.46\"],\"2\",[\"12\"],[\"107.6\"]],[[\"Зп-000000011\"],[\"На рассмотрении\"],[\"Отменена\"],[\"0000001921\"],[\"2019-08-16 00:00:00.0\"],[\"102\"],[\"73\"],[\"69\"],null,null,\"1\",[\"1\"],[\"7\"]]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"28\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"6177fd15ae4e0fed329babb7\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2021-10-26T13:06:13.436Z\",\"version\":1000000}","type":"YQL_QUERY"},{"cacheKey":null,"base64Value":null,"type":"YT_DATA"}]