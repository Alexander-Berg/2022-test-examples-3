[{"hashKey":"f7d2a69e4d5ebf60d04fd7728defd368","query":"USE hahn; PRAGMA yt.InferSchema = '1';\nPRAGMA AnsiInForEmptyOrNullableItemsCollections;\n\n$is_moscow = ($region_id) -> {\n   return $region_id = 145;\n};\n\n$warehouses_with_regions = (\n    select\n        wh.id as id,\n        wh.region_id as region_id\n    from `/home/market/production/replenishment/order_planning/2020-12-12/intermediate/warehouses`  with inline as wh\n);\n\n$is_1P = ($supplier_id) -> { return $supplier_id == 465852};\n\n$fullfilment_partners = (\n    SELECT id\n        FROM `/home/market/production/mbi/dictionaries/partner_biz_snapshot/latest`  with inline\n        WHERE is_fullfilment = 1\n);\n\n$msku_with_fullfilment_supplier = (\n    SELECT approved_market_sku_id as msku\n    FROM `/home/market/production/ir/ultra-controller/supplier_to_market_sku`  with inline\n    WHERE shop_id in $fullfilment_partners\n);\n\n$assortment_with_new_msku = (\n    SELECT\n        msku\n    FROM `/home/market/production/mbo/export/recent/models/sku`  with inline AS sku\n        LEFT JOIN `/home/market/production/mstat/dictionaries/mbo/sku_transitions/latest`  with inline AS sku_transitions\n            ON sku.model_id = sku_transitions.old_entity_id\n    WHERE sku.model_id > 0 AND sku.title != '' AND sku.category_id > 0\n    AND COALESCE(sku_transitions.new_entity_id, sku.model_id) IN $msku_with_fullfilment_supplier\n    GROUP BY COALESCE(sku_transitions.new_entity_id, sku.model_id) as msku\n);\n\n$assortment = (\n    SELECT\n        mskus.msku AS msku,\n        region.region_id AS region\n    FROM $assortment_with_new_msku AS mskus\n        CROSS JOIN `/home/market/production/replenishment/order_planning/2020-12-12/intermediate/regions`  with inline AS region\n);\n\n$forecast = (SELECT\n        msku,\n        f.region AS region,\n        sum(f.demand) AS forecast_1p,\n        sum(f.total_demand) AS forecast\n    FROM `/home/market/production/replenishment/order_planning/2020-12-05/intermediate/forecast_region`  with inline AS f\n        LEFT JOIN `/home/market/production/mstat/dictionaries/mbo/sku_transitions/latest`  with inline AS sku_transitions\n            ON f.msku = sku_transitions.old_entity_id\n    WHERE f.`date` = '2020-12-12'\n    GROUP BY COALESCE(sku_transitions.new_entity_id, f.msku) as msku, f.region\n);\n\n$oos = (SELECT\n        msku,\n        region,\n        sum(s.missed_orders) as missed_orders\n    FROM `/home/market/production/replenishment/order_planning/2020-12-12/intermediate/suppliers_demand`  with inline as s\n        INNER JOIN `/home/market/production/replenishment/order_planning/2020-12-12/intermediate/warehouses`  with inline as w\n            ON w.id = s.warehouse_id\n    WHERE s.supplier_id > 0 AND s.supplier_id IN $fullfilment_partners AND CAST(s.`date` as Date) = CAST('2020-12-12' as Date)\n    GROUP BY s.msku as msku, w.region_id as region\n    HAVING NOT bool_or(s.on_stock)\n);\n\n$stock = (SELECT\n        msku as msku,\n        region,\n        sum_if(greatest(available_amount, 0), $is_1P(supplier_id)) as stock_1P,\n        sum_if(greatest(available_amount, 0), not $is_1P(supplier_id) ) as stock_3P\n    FROM `/home/market/production/mstat/dictionaries/stock_sku/1d/2020-12-12`  with inline as stock\n        LEFT JOIN `/home/market/production/ir/ultra-controller/supplier_to_market_sku`  with inline as mapping\n            ON stock.shop_sku = mapping.shop_sku_id AND stock.supplier_id = mapping.shop_id\n        LEFT JOIN $warehouses_with_regions as wwr\n            ON stock.warehouse_id = wwr.id\n        LEFT JOIN `/home/market/production/mstat/dictionaries/mbo/sku_transitions/latest`  with inline AS sku_transitions\n            ON mapping.approved_market_sku_id = sku_transitions.old_entity_id\n    WHERE $is_moscow(wwr.region_id)\n        AND mapping.approved_market_sku_id > 0\n    GROUP BY COALESCE(sku_transitions.new_entity_id, mapping.approved_market_sku_id) as msku, wwr.region_id as region\n);\n\nSELECT\n    a.msku AS msku,\n    a.region AS region,\n    f.forecast_1p as forecast_1p,\n    f.forecast as forecast,\n    oos.missed_orders as missed_orders,\n    s.stock_1P as stock_1P,\n    s.stock_3P as stock_3P\nFROM $assortment as a\n    LEFT JOIN $forecast as f ON a.msku = f.msku AND a.region = f.region\n    LEFT JOIN $oos as oos ON a.msku = oos.msku AND a.region = oos.region\n    LEFT JOIN $stock as s ON a.msku = s.msku AND a.region = s.region\nWHERE (f.msku IS NOT NULL\n   OR oos.msku IS NOT NULL\n   OR s.msku IS NOT NULL);\n","data":"{\"data\":[ {\"Write\":[{\"Type\":[\"ListType\",[\"StructType\",[[\"msku\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"region\",[\"DataType\",\"Int64\"]],[\"forecast_1p\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"forecast\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"missed_orders\",[\"OptionalType\",[\"DataType\",\"Double\"]]],[\"stock_1P\",[\"OptionalType\",[\"DataType\",\"Int64\"]]],[\"stock_3P\",[\"OptionalType\",[\"DataType\",\"Int64\"]]]]]],\"Data\":[[[\"107981\"],\"145\",[\"0.1\"],[\"0.2\"],[\"1.5\"],[\"11\"],[\"7\"]],[[\"107981\"],\"147\",[\"3.5\"],[\"7\"],[\"1.6\"],null,null],[[\"107981\"],\"300\",[\"4\"],[\"8\"],[\"1\"],null,null],[[\"107981\"],\"301\",[\"7.5\"],[\"10\"],[\"1\"],null,null],[[\"107981\"],\"302\",[\"6\"],[\"12\"],[\"1\"],null,null]]}],\"Position\":{\"Column\":\"1\",\"Row\":\"89\",\"File\":\"<main>\"}}],\"errors\":[],\"id\":\"6290933197c5b79a03d8f95d\",\"issues\":[],\"status\":\"COMPLETED\",\"updatedAt\":\"2022-05-27T09:02:08.985Z\",\"version\":1000000}","type":"YQL_QUERY"},{"cacheKey":null,"base64Value":null,"type":"YT_DATA"}]