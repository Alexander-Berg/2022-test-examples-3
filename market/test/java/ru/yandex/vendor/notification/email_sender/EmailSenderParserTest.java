package ru.yandex.vendor.notification.email_sender;

import org.apache.logging.log4j.util.Strings;
import org.junit.jupiter.api.Test;

import ru.yandex.utils.IoUtils;
import ru.yandex.vendor.notification.email_sender.parser.email.EmailSenderParser;
import ru.yandex.vendor.notification.email_sender.parser.email.IEmailSenderParser;
import ru.yandex.vendor.notification.email_sender.parser.email.rule.EmailSenderParserCompositeTextRule;
import ru.yandex.vendor.notification.email_sender.parser.email.rule.EmailSenderParserSimpleUrlRule;
import ru.yandex.vendor.notification.email_sender.parser.email.rule.EmailSenderParserTextRule;
import ru.yandex.vendor.notification.email_sender.parser.email.rule.EmailSenderParserUrlRule;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static ru.yandex.vendor.notification.email_sender.parser.email.rule.EmailSenderParserCompositeTextRule.DEFAULT_TEXT_MARKER;
import static ru.yandex.vendor.notification.email_sender.parser.email.rule.EmailSenderParserSimpleUrlRule.DEFAULT_SIMPLE_URL_MARKER;
import static ru.yandex.vendor.notification.email_sender.parser.email.rule.EmailSenderParserUrlRule.DEFAULT_BASE_COMPOSITE_URL_TEXT_MARKER;
import static ru.yandex.vendor.notification.email_sender.parser.email.rule.EmailSenderParserUrlRule.DEFAULT_COMPOSITE_URL_MARKER;

class EmailSenderParserTest {

    private static final String HTML_WITH_MARKDOWN = "\t<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.0 Transitional//EN\">\n<html>\n<head> \n  <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\n  <title>Продавец отказался быть рекомендованным магазином бренда Крутой бренд</title>\n\n  <style type=\"text/css\">\nhtml {\n    -webkit-text-size-adjust: none;\n    -ms-text-size-adjust: none;\n}\n\n@media screen and (max-device-width: 420px), screen and (max-width: 420px) {\n    .mob-center {\n        display: block !important;\n        margin: 0 auto !important;\n        text-align: center !important;\n        float: none !important;\n    }\n}\n</style>\n<link rel=\"shortcut icon\" href=\"https://yastatic.net/market-export/_/i/favicon.ico\"><link rel=\"shortcut icon\" href=\"https://yastatic.net/market-export/_/i/favicon-16.png\" sizes=\"16x16\"><link rel=\"shortcut icon\" href=\"https://yastatic.net/market-export/_/i/favicon-32.png\" sizes=\"32x32\"><link rel=\"shortcut icon\" href=\"https://yastatic.net/market-export/_/i/favicon-96.png\" sizes=\"96x96\"><link rel=\"shortcut icon\" href=\"https://yastatic.net/market-export/_/i/favicon-194.png\" sizes=\"194x194\">\n\n </head> \n\n<body style=\"padding:0px;margin:0px;\"> \n<table width=\"100%%\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\">\n  <tbody><tr>\n    <td align=\"center\" bgcolor=\"#ffffff\">\n\n      <!--[if (gte mso 9)|(IE)]>\n      <table width=\"700\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\">\n        <tr>\n          <td>\n      <![endif]-->\n      <div style=\"max-width:700px;\">\n        <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%%\" style=\"max-width: 700px;min-width:320px;\">\n          <tbody><tr>\n            <td align=\"center\" class=\"bg\" bgcolor=\"#F5F4F2\" style=\"background: #F5F4F2;\">\n              <!--[if (gte mso 9)|(IE)]>\n              <table width=\"600\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\">\n                <tr>\n                  <td>\n              <![endif]-->\n              <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"98%%\" style=\"max-width: 600px;\" align=\"center\">\n                <tbody>\n\n               \n                <!-- - - - - - - BEGIN: PREHEADER  - - - - - - -->\n                <tr>\n                  <td align=\"center\">\n                    <div style=\"height: 15px; line-height:15px; font-size:16px;\">&nbsp;</div>\n                    \n                    <div style=\"height: 15px; line-height:15px; font-size:16px;\">&nbsp;</div>\n                  </td>\n                </tr>\n                <!-- - - - - - - END: PREHEADER  - - - - - - - -->\n \n\n                <!-- - - - - - - BEGIN: HEADER  - - - - - - -->\n                <tr>\n                  <td>\n                    <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%%\">\n                      <tbody>\n                      <tr>\n                        <td align=\"left\">\n                          <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\">\n                            <tbody>\n                            <tr>\n                              <td>\n                                <a href=\"{%% wrap \"1\" %%}https://market.yandex.ru{%% endwrap %%}\" target=\"_blank\" class=\"nobordered\" style=\"font-family: Arial, sans-serif; font-weight: 400; line-height: normal; color: #282828; border: none;\"><img src=\"http://img5.expertsender.com/market.yandex.ru/letters/281216/img/logo.png\" width=\"152\" height=\"30\" alt=\"\" style=\"display: block; border: none;\"></a>\n                              </td>\n                            </tr>\n                            </tbody>\n                          </table>\n                        </td>\n                        <td align=\"right\">\n                          <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" align=\"right\">\n                            <tbody>\n                            <tr>\n                              <td align=\"right\">\n                                <a href=\"{%% wrap \"2\" %%}https://market.yandex.ru{%% endwrap %%}\" target=\"_blank\" class=\"nobordered\" style=\"font-family: Arial, sans-serif; font-weight: 400; line-height: normal; color: #282828; border: none;\"><img src=\"http://img5.expertsender.com/market.yandex.ru/letters/250416/img/icon-cart.png\" width=\"32\" height=\"32\" alt=\"\" style=\"display: block; border: none;\"></a>\n                              </td>\n                            </tr>\n                            </tbody>\n                          </table>\n                        </td>\n                      </tr>\n                      </tbody>\n                    </table>\n                  </td>\n                </tr>\n                <!-- - - - - - - END: HEADER  - - - - - - - -->\n\n                <tr>\n                  <td>\n                    <div style=\"height: 15px; line-height:15px; font-size:16px;\">&nbsp;</div>\n                  </td>\n                </tr>\n                \n                <!-- - - - - - - BEGIN: CONTENT  - - - - - - -->\n                <tr>\n                  <td align=\"center\" class=\"white\" bgcolor=\"#FFFFFF\" style=\"background: #FFFFFF;\">\n                    <!--[if (gte mso 9)|(IE)]>\n                    <table width=\"520\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" align=\"center\">\n                      <tr>\n                        <td align=\"center\">\n                    <![endif]-->\n                    <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" style=\"max-width: 520px\" width=\"96%%\" align=\"center\">\n                      <tbody>\n                      <tr>\n                        <td>\n                          <div style=\"height: 40px; line-height:40px; font-size:40px;\">&nbsp;</div>\n                        </td>\n                      </tr>\n                      <tr>\n                        <td>\n                          <span class=\"c2\" style=\"font-family: Arial, sans-serif; font-weight: 400; color: #282828; line-height: 21px; font-size: 15px;\">\n                            \n                            <span class=\"c3 vendors-text\" style=\"font-family: Arial, sans-serif; font-weight: 400; line-height: normal; color: #282828; font-size: 21px;\">Здравствуйте!</span>\n\n\n\t\t\n\t\t                        <div id=\"result\"><section class=\"b-article-text_yablogs _init\" data-block=\"b-article-text\"><p class=\"vendors-text\">Магазин <a class=\"vendors-simple-url\" href=\"https://market.yandex.ru/shop/1\" style=\"font-family:Arial,Helvetica,sans-serif;color:#3c7ab9;text-decoration:none;\" target=\"_blank\">Крутой магаз</a>, который бренд Крутой бренд включил в&nbsp;свой список рекомендованных, отказался от&nbsp;участия в&nbsp;программе. Вы&nbsp;можете удалить его из&nbsp;списка и&nbsp;добавить вместо него другого продавца.</p></section>\n\n                            </div>\n\t\t\n\t\t\t                    </span></td>\n                       </tr>\n\n\n\n\n\n                      <tr><td align=\"center\">\n                      <table width=\"100%%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n                      <tr>\n                      <td align=\"left\">\n        \n                      <!-- padding --><div style=\"height: 30px; line-height:30px; font-size:8px;\">&nbsp;</div>\n        \n                      \n\n\n                      <!--big btn -->\n                      <table cellpadding=\"0\" width=\"100%%\" style=\"max-width: 100%%;\" border=\"0\" cellspacing=\"0\">\n                      <tbody><tr><td align=\"center\">\n                          <table cellpadding=\"0\" width=\"186\" align=\"left\" border=\"0\" cellspacing=\"0\">\n                            <tbody><tr><td align=\"left\" height=\"50\" valign=\"top\">\n                            <a class=\"vendors-url\" href=\"https://vendor.market.yandex.ru/vendors/1/shops\" target=\"_blank\">\n                            <img class=\"vendors-url-text_attr-alt\" src=\"http://img5.expertsender.com/market.yandex.ru/letters/transaction/img/vendor_go_to_account.png\" style=\"display: block;\"  alt=\"В личный кабинет\" border=\"0\" height=\"48\"/>\n                            </a></td></tr>\n                            </tbody>\n                          </table>                      \n                      </td></tr></tbody>\n                      </table>\n                      <!--big btn END-->\n\n\n\n        \n                      </td>\n                      </tr>\n\n\n\n                      <tr>\n                        <td>\n                          <!-- padding --><div style=\"height: 20px; line-height:20px; font-size:8px;\">&nbsp;</div>\n                          <span class=\"c2\" style=\"font-family: Arial, sans-serif; font-weight: 400; color: #282828; line-height: 21px; font-size: 15px;\">\n                               \n                            <div id=\"result\"><section class=\"b-article-text_yablogs _init\" data-block=\"b-article-text\"><p>Если у&nbsp;вас возникли вопросы, обращайтесь к&nbsp;вашему менеджеру или в&nbsp;службу поддержки на&nbsp;<a href=\"mailto:vendor@market.yandex.ru\" style=\"font-family:Arial,Helvetica,sans-serif;color:#3c7ab9;text-decoration:none;\" target=\"_blank\">vendor@market.yandex.ru</a></p></section>\n\n                            </div>\n    \n                          </span></td>\n                      </tr>\n\n\n\n                      <tr>\n                        <td>\n                          <div style=\"height: 30px; line-height:30px; font-size:30px;\">&nbsp;</div>\n                          <span class=\"c4\" style=\"font-family: Arial, sans-serif; font-weight: 400; line-height: normal; color: #858585; font-size: 15px;\">Команда Яндекс.Маркета</span>\n                          <div style=\"height: 40px; line-height:40px; font-size:40px;\">&nbsp;</div>\n                        </td>\n                      </tr>\n                      </tbody>\n                    </table>\n                    <!--[if (gte mso 9)|(IE)]>\n                    </td>\n                    </tr>\n                    </table>\n                    <![endif]-->\n                  </td>\n                </tr>\n\n\n                \n\n                <!-- - - - - - - END: CONTENT  - - - - - - - -->\n\n                <!-- - - - - - - BEGIN: LINKS  - - - - - - -->\n                <tr>\n                  <td bgcolor=\"#FFFFFF\" align=\"center\" style=\"background: #FFFFFF; \">\n                    <!--[if (gte mso 9)|(IE)]>\n                    <table width=\"520\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" align=\"center\">\n                      <tr>\n                        <td>\n                    <![endif]-->\n                   \n                    <!--[if (gte mso 9)|(IE)]>\n                    </td>\n                    </tr>\n                    </table>\n                    <![endif]-->\n                  </td>\n                </tr>\n                <!-- - - - - - - END: LINKS  - - - - - - - -->\n\n\n\n                </tbody>\n              </table>\n              <!--[if (gte mso 9)|(IE)]>\n              </td>\n              </tr>\n              </table>\n              <![endif]-->\n            </td>\n          </tr>\n\n          \n\n         <tr><td align=\"center\">\n    <!-- padding --><div style=\"height:20px;line-height:20px;font-size:25px;\">&nbsp;</div>\n    <!-- footer_text -->\n    <table width=\"100%%\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" style=\n    \"max-width:100%%;\"><tr>\n      <td align=\"left\">\n        <!-- padding --><div style=\"height:5px;line-height:5px;font-size:2px;\">&nbsp;</div>\n        <div style=\"line-height:16px;\">\n          <span style=\"font-family:Tahoma, Arial, Helvetica, sans-serif;font-size:13px;color:#939393;line-height:16px;\">\n          Это письмо разослали автоматически — ответ на&nbsp;него мы&nbsp;не&nbsp;увидим.\n          </span>\n        </div>\n        <!-- padding --><div style=\"height:20px;line-height:20px;font-size:8px;\">&nbsp;</div>\n      </td></tr>\n    </table></td></tr>\n\n\n\n\n\n\n                <!-- - - - - - - BEGIN: FOOTER  - - - - - - -->\n                <tr>\n                  <td align=\"center\" class=\"bg\" bgcolor=\"#F5F4F2\" style=\"background: #F5F4F2;\">\n                    <!--[if (gte mso 9)|(IE)]>\n                    <table width=\"600\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\">\n                     <tr>\n                      <td>\n                    <![endif]-->\n                    <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" align=\"center\" width=\"98%%\" style=\"max-width: 600px;\">\n                      <tbody>\n                      <tr>\n                        <td>\n                           <div style=\"height: 15px; line-height:15px; font-size:15px;\">&nbsp;</div>\n                        </td>\n                      </tr>\n                      <tr>\n                        <td align=\"center\">\n\n                        <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" align=\"center\" width=\"100%%\">\n                          <tbody>\n                          <tr>\n                            <td>\n                          <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%%\">\n                            <tbody>\n                            <tr>\n                              <td>\n                                <!--[if (gte mso 9)|(IE)]>\n                                <table width=\"600\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" align=\"center\">\n                                  <tr>\n                                    <td>\n                                <![endif]-->\n                                <div style=\"display: inline-block;vertical-align: top;\" class=\"mob-center\">\n                                  <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" class=\"mob-center\">\n                                    <tbody>\n                                    <tr>\n                                      <td valign=\"top\" class=\"mob-center\">\n                                        <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" class=\"mob-center\">\n                                          <tbody>\n                                          \n                                          <tr>\n                                            <td>\n                                              <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" class=\"mob-center\">\n                                                <tbody>\n                                                <tr>\n                                                  <td><a href=\"{%% wrap \"5\" %%}https://www.facebook.com/YaMarketB2B/{%% endwrap %%}\" target=\"_blank\" class=\"nobordered\" style=\"font-family: Arial, sans-serif; font-weight: 400; line-height: normal; color: #282828; border: none;\"><img src=\"http://img5.expertsender.com/market.yandex.ru/letters/250416/img/fb.png\" width=\"25\" alt=\"\" style=\"display: block; border: none;height:auto;\"></a></td>\n                                                  <td width=\"4\">&nbsp;</td>\n                                                  <td><a href=\"{%% wrap \"6\" %%}https://vk.com/yamarketb2b{%% endwrap %%}\" target=\"_blank\" class=\"nobordered\" style=\"font-family: Arial, sans-serif; font-weight: 400; line-height: normal; color: #282828; border: none;\"><img src=\"http://img5.expertsender.com/market.yandex.ru/letters/250416/img/vk.png\" width=\"25\" alt=\"\" style=\"display: block; border: none;height:auto;\"></a></td>\n                                                  <td width=\"4\">&nbsp;</td>\n                                                  <td><a href=\"{%% wrap \"7\" %%}https://www.youtube.com/channel/UCi6nhZ53_CzR2THquBWolfQ{%% endwrap %%}\" target=\"_blank\" class=\"nobordered\" style=\"font-family: Arial, sans-serif; font-weight: 400; line-height: normal; color: #282828; border: none;\"><img src=\"http://img5.expertsender.com/market.yandex.ru/letters/250416/img/yb.png\" width=\"25\" alt=\"\" style=\"display: block; border: none;height:auto;\"></a></td>\n                                                  \n                                                  \n                                                </tr>\n                                                </tbody>\n                                              </table>\n                                            </td>\n                                          </tr>\n                                          <tr>\n                                            <td>\n                                              <div style=\"height: 15px; line-height:15px; font-size:16px;\">&nbsp;</div>\n                                            </td>\n                                          </tr>\n                                          </tbody>\n                                        </table>\n                                      </td>\n                                    </tr>\n                                    </tbody>\n                                  </table>\n                                </div>\n                                <!--[if (gte mso 9)|(IE)]>\n                                </td>\n\n                                <td align=\"right\">\n                                <![endif]-->\n                                <div style=\"display: inline-block;vertical-align: top;float:right\" class=\"mob-center\">\n                                  <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" class=\"mob-center\">\n                                    <tbody>\n                                    <tr>\n                                      <td valign=\"top\" class=\"mob-center\">\n                                        <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" class=\"mob-center\">\n                                          <tbody>\n                                          <tr>\n                                            <td align=\"right\" class=\"mob-center\"><span class=\"c5\" style=\"font-family: Arial, sans-serif; font-weight: 400; line-height: normal; color: #282828; font-size: 13px;\">© {{year}}&nbsp;«Яндекс.Маркет»</span></td>\n                                          </tr>\n                                          <tr>\n                                            <td>\n                                              <div style=\"height: 15px; line-height:15px; font-size:16px;\">&nbsp;</div>\n                                            </td>\n                                          </tr>\n                                         \n                                          </tbody>\n                                        </table>\n                                      </td>\n                                    </tr>\n                                    <tr>\n                                      <td>\n                                        <div style=\"height: 15px; line-height:15px; font-size:16px;\">&nbsp;</div>\n                                      </td>\n                                    </tr>\n                                    </tbody>\n                                  </table>\n                                </div>\n                                <!--[if (gte mso 9)|(IE)]>\n                                </td>\n                                </tr>\n                                </table>\n                                <![endif]-->\n                              </td>\n\n                            </tr>\n                            </tbody>\n                          </table>\n                        </td>\n                      </tr>\n                      </tbody>\n                    </table>\n\n                  </td>\n                </tr>\n                <tr>\n                  <td>\n                    <div style=\"height: 10px; line-height:10px; font-size:10px;\">&nbsp;</div>\n                  </td>\n                </tr>\n                </tbody>\n              </table>\n\n              <!--[if (gte mso 9)|(IE)]>\n              </td>\n              </tr>\n              </table>\n              <![endif]-->\n            </td>\n          </tr>\n          <!-- - - - - - - END: FOOTER  - - - - - - - -->\n        </tbody></table>\n      </div>\n      <!--[if (gte mso 9)|(IE)]>\n      </td></tr>\n      </table>\n      <![endif]-->\n    \n\n    \n    </td>\n  </tr>\n\n</tbody></table>\n {%% opens_counter %%}</body>\n\n</html> ";

    private static final String WITH_MARKDOWN_EXPECTED_RESULT = "Здравствуйте!\nМагазин [Крутой магаз](https://market.yandex.ru/shop/1), который бренд Крутой бренд включил в свой список рекомендованных, отказался от участия в программе. Вы можете удалить его из списка и добавить вместо него другого продавца.\n[В личный кабинет](/vendors/1/shops)";

    private static final String HTML_WITHOUT_MARKDOWN = "<html><head></head><body><p>Тест</p></body></html>";

    private IEmailSenderParser emailSenderParser;

    public EmailSenderParserTest() {
        this.emailSenderParser = emailTemplateParser();

    }

    @Test
    void testHtmlParsingWithMarkdown() {
        String actual = emailSenderParser.parseEmail(HTML_WITH_MARKDOWN);
        assertEquals(WITH_MARKDOWN_EXPECTED_RESULT, actual);
    }

    @Test
    void testHtmlParsingWithoutMarkdown() {
        String actual = emailSenderParser.parseEmail(HTML_WITHOUT_MARKDOWN);
        assertEquals(Strings.EMPTY, actual);
    }

    @Test
    void testQuestionsHtmlParser() {
        String html = readResourceAsString("questions.html");

        String expected = readResourceAsString("expected.txt").replaceAll("[^а-яА-Яa-zA-Z0-9_]", "");
        String actual = emailSenderParser.parseEmail(html).replaceAll("[^а-яА-Яa-zA-Z0-9_]", "");
        assertEquals(expected, actual);
    }

    private String readResourceAsString(String resource) {
        return IoUtils.loadResource(getClass().getResourceAsStream("EmailSenderParserTest/" + resource));
    }

    public IEmailSenderParser emailTemplateParser() {
        EmailSenderParserTextRule textRule = new EmailSenderParserTextRule();
        EmailSenderParserSimpleUrlRule simpleUrlRule = new EmailSenderParserSimpleUrlRule(DEFAULT_SIMPLE_URL_MARKER, textRule);
        EmailSenderParserUrlRule urlRule = new EmailSenderParserUrlRule(DEFAULT_COMPOSITE_URL_MARKER, DEFAULT_BASE_COMPOSITE_URL_TEXT_MARKER, textRule);
        EmailSenderParserCompositeTextRule compositeTextRule = new EmailSenderParserCompositeTextRule(
                DEFAULT_TEXT_MARKER,
                textRule,
                simpleUrlRule
        );

        return new EmailSenderParser(
                compositeTextRule,
                urlRule
        );
    }
}
