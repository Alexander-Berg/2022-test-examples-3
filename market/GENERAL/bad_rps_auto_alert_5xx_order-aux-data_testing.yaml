name: RPS_5xx order-aux-data alert generated by SPOK (testing)
description: ''
windowSecs: 3600
delaySecs: 0
type:
  expression:
    program: |-
      let rps = {
        'cluster'='testing',
        'dc'='-',
        'environment'='testing',
        'host'='-',
        'http_handle_by_method'='-',
        'liveness_handle'='-',
        'period'='one_min',
        'project'='market-checkout',
        'sensor'='RPS',
        'service'='order-aux-data_ag',
        'error_codes'='-'
      };

      let totalAvgRps = median(constant_line(0) + rps);
      ok_if(totalAvgRps < 10);

      let errors = {
        'cluster'='testing',
        'environment'='testing',
        'period'='one_min',
        'http_handle_by_method'='-',
        'service'='order-aux-data_ag',
        'host'='-',
        'project'='market-checkout',
        'sensor'='errors',
        'error_codes'='5xx',
        'liveness_handle'='-',
        'dc'='-'
      };

      let medianErrors = median(constant_line(0) + errors);
      let lastErrors = tail(drop_empty_lines(errors), 5m);
      let lastAvgErrors = size(lastErrors) > 0 ? avg(lastErrors) : 0;

      alarm_if(lastAvgErrors > 300 * medianErrors / 100);
      warn_if(lastAvgErrors > 150 * medianErrors / 100);
    checkExpression: ''
groupByLabels:
- error_codes
annotations:
  juggler_service: order-aux-data_rps_errors_testing_{{labels.error_codes}}
  lastAvgErrors: '{{expression.lastAvgErrors}}'
  medianErrors: '{{expression.medianErrors}}'
  totalAvgRps: '{{expression.totalAvgRps}}'
channels:
- id: juggler_spok_channel
  config: {}
