from market.replenishment.algorithms.lib.data_preparation.suppliers_demand.ewma_script import ewma_

# Для простоты копирования из YQL
false = False
true = True

lags = [
    -56, -55, -54, -53, -52, -51, -50, -49, -48, -47, -46, -45, -44, -43, -42, -41, -40, -39, -38, -37, -36, -35, -34,
    -33, -32, -31, -30, -29, -28, -27, -26, -25, -24, -23, -22, -21, -20, -19, -18, -17, -16, -15, -14, -13, -12, -11,
    -10, -9, -8, -7, -6, -5, -4, -3, -2, -1, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21,
    22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
    51, 52, 53, 54, 55, 56
]


def test_1():
    assert ewma_(
        [
            (
                1,
                false,
                -1
            ),
            (
                2,
                false,
                -1
            ),
            (
                3,
                true,
                10
            ),
            (
                4,
                false,
                -1
            ),
        ],
        lags
    ) == [(1, 10), (2, 10), (3, 0), (4, 10)]


def test_2():
    assert ewma_(
        [
            (
                1,
                false,
                -1
            ),
            (
                2,
                false,
                -1
            ),
            (
                3,
                true,
                10
            ),
            (
                4,
                true,
                20
            ),
        ],
        lags
    ) == [(1, 13.076923076923077), (2, 12.0), (3, 20.0), (4, 10.0)]


def test_2_long():
    assert ewma_(
        [
            (
                1,
                false,
                -1
            ),
            (
                2,
                false,
                -1
            ),
            (
                3,
                false,
                -1
            ),
            (
                4,
                false,
                -1
            ),
            (
                5,
                true,
                10
            ),
            (
                6,
                true,
                20
            ),
        ],
        lags
    ) == [(1, 13.902439024390244),
          (2, 13.600000000000001),
          (3, 13.076923076923077),
          (4, 12.0),
          (5, 20.0),
          (6, 10.0)]


def test_2_long_with_missed_dates():
    assert ewma_(
        [
            (
                1,
                false,
                -1
            ),
            (
                5,
                true,
                10
            ),
            (
                6,
                true,
                20
            ),
        ],
        lags
    ) == [(1, 13.902439024390244),
          (2, 13.600000000000001),
          (3, 13.076923076923077),
          (4, 12.0),
          (5, 20.0),
          (6, 10.0)]


def test_3():
    assert ewma_(
        [
            (
                1,
                false,
                -1
            ),
            (
                2,
                false,
                -1
            ),
            (
                3,
                false,
                -1
            ),
            (
                4,
                false,
                -1
            ),
        ],
        lags
    ) == [(1, 0), (2, 0), (3, 0), (4, 0)]


def test_4():
    assert ewma_(
        [
            (
                1,
                false,
                -1
            ),
            (
                2,
                false,
                -1
            ),
            (
                3,
                false,
                -1
            ),
            (
                5,
                false,
                -1
            ),
        ],
        lags
    ) == [(1, 0), (2, 0), (3, 0), (4, 0), (5, 0)]


def test_5():
    assert ewma_(
        [
            (
                1,
                false,
                -1
            ),
            (
                2,
                false,
                -1
            ),
            (
                3,
                true,
                10
            ),
            (
                6,
                true,
                20
            ),
        ],
        lags
    ) == [(1, 11.379310344827587),
          (2, 10.588235294117647),
          (3, 20.000000000000004),
          (4, 12.0),
          (5, 18.0),
          (6, 10.000000000000002)]


def test_6():
    assert ewma_(
        [
            (
                1,
                false,
                -1
            ),
            (
                2,
                false,
                -1
            ),
            (
                3,
                true,
                10
            ),
            (
                5,
                true,
                20
            ),
        ],
        lags
    ) == [(1, 12.0), (2, 10.999999999999998), (3, 20.0), (4, 15.0), (5, 10.0)]


def test_7():
    assert ewma_(
        [
            (
                1,
                false,
                -1
            ),
            (
                2,
                false,
                -1
            ),
            (
                3,
                true,
                10
            ),
            (
                5,
                true,
                20
            ),
            (
                6,
                true,
                25
            ),
            (
                7,
                true,
                20
            ),
            (
                8,
                false,
                -1
            ),
            (
                12,
                true,
                10
            ),
        ],
        lags
    ) == [(1, 13.867733339635684),
          (2, 12.001135073779794),
          (3, 20.99115044247788),
          (4, 16.252739225712197),
          (5, 21.510067114093957),
          (6, 19.350649350649352),
          (7, 22.939001848428834),
          (8, 20.153729360409944),
          (9, 18.51851851851852),
          (10, 15.058912404399104),
          (11, 11.311435670565421),
          (12, 20.153504924688608)]


def test_8():
    assert ewma_(
        [
            (
                1,
                false,
                -1
            ),
            (
                2,
                false,
                -1
            ),
            (
                3,
                true,
                10
            ),
            (
                5,
                true,
                20
            ),
            (
                6,
                false,
                -1
            ),
            (
                7,
                true,
                20
            ),
            (
                8,
                false,
                -1
            ),
            (
                12,
                true,
                10
            ),
        ],
        lags
    ) == [(1, 12.590153136835173),
          (2, 11.301435406698563),
          (3, 19.619952494061756),
          (4, 15.224489795918366),
          (5, 14.80392156862745),
          (6, 19.350649350649352),
          (7, 17.092198581560286),
          (8, 19.15541313801785),
          (9, 16.923076923076923),
          (10, 13.58491581042552),
          (11, 10.816326530612246),
          (12, 18.303089070508378)]


def test_repeated_dates_not_fail():
    records = [(18981, False, 0.0), (18982, True, 1.0), (18982, False, 0.0)]
    expected = [(18981, 1), (18982, 0)]
    assert ewma_(records, lags) == expected
