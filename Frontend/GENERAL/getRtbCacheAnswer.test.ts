import { ApphostContext } from '@yandex-int/frontend-apphost-context';
import {
    getRtbCacheAnswer,
} from './index';

const apphostContextMock = {
    setResponseHeader: () => {}
} as unknown as ApphostContext;

const defaultQueryMock = {};

describe('getRtbCacheAnswer', () => {
    it('MediaCreative. base64 encoded', () => {
        // rtb.data.dc_params.data_params
        const bsMeta = '{"rtb":{"data":{"needBase64Html": true, "dc_params":{"data_params":{}}}}}';
        const adaptedMeta = '{"rtb":{"html":"PCFET0NUWVBFIGh0bWw-CiAgICAgICAgPGh0bWwgbGFuZz0iZW4iPgogICAgICAgICAgICA8aGVhZD4KICAgICAgICAgICAgICAgIDxtZXRhIGNoYXJzZXQ9IlVURi04Ij4KICAgICAgICAgICAgICAgIDx0aXRsZT5UaXRsZTwvdGl0bGU-CiAgICAgICAgICAgIDwvaGVhZD4KICAgICAgICAgICAgPGJvZHkgc3R5bGU9Im1hcmdpbjowOyI-CiAgICAgICAgICAgICAgICA8c2NyaXB0IHNyYz0iaHR0cHM6Ly95YW5kZXgucnUvYWRzL3N5c3RlbS9tZWRpYS5qcyI-PC9zY3JpcHQ-CiAgICAgICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5ZYS5tZWRpYUNvZGUuY3JlYXRlKAogICAgICAgICAgICAgICAgICAgICAgICB7Im5hbWUiOiJtZWRpYS1iYW5uZXJfdGhlbWVfc3BlZWR5IiwidmVyc2lvbiI6Mn0sCiAgICAgICAgICAgICAgICAgICAgICAgIHsibWVkaWFTZXRzIjp7InVuaXExIjp7Iml0ZW1zIjpbeyJpdGVtcyI6W3siaXNEZWZhdWx0IjpmYWxzZSwidXJsIjoiaHR0cHM6Ly9hdmF0YXJzLm1kcy55YW5kZXgubmV0L2dldC1jYW52YXMvMzU2ODQwOC8yYTAwMDAwMTc3YjUwMGVkY2JkYmRjZWM2MWEyZmVmZjdkMmMvY3JvcFNvdXJjZSIsImFsaWFzIjoibm9ybWFsIiwiZmlsZUlkIjoiNjAyZTU0ZGU3YTZmYjIwMDY5NzI3Mjc0IiwiY3JvcHBlZEZpbGVJZCI6IjYwMmU1NjQyN2E2ZmIyMDA2OTcyNzJiNiIsImhlaWdodCI6OTYsIndpZHRoIjo2MzZ9XSwidHlwZSI6ImltYWdlIn1dfX0sIm9wdGlvbnMiOnsiYm9yZGVyQ29sb3IiOiIjRjQxODE4IiwiYmFja2dyb3VuZENvbG9yIjoiI0ZERTkwMCIsImhhc0FuaW1hdGlvbiI6dHJ1ZSwiaXNBZGFwdGl2ZSI6ZmFsc2V9LCJidW5kbGUiOnsibmFtZSI6Im1lZGlhLWJhbm5lcl90aGVtZV9zcGVlZHkiLCJ2ZXJzaW9uIjoyfSwiZWxlbWVudHMiOlt7InR5cGUiOiJpbWFnZSIsIm1lZGlhU2V0IjoidW5pcTEiLCJvcHRpb25zIjp7IndpZHRoIjozMTgsImhlaWdodCI6NDh9LCJhdmFpbGFibGUiOnRydWV9LHsidHlwZSI6ImhlYWRsaW5lIiwibWF4TGVuZ3RoIjo2MCwib3B0aW9ucyI6eyJjb2xvciI6IiNGRkZGRkYiLCJjb250ZW50Ijoi0J7Qv9GA0YvRgdC60LjQstCw0YLQtdC70Ywg0KLQuNGC0LDQvS0zMDAwLTI0LiAg0JTQu9GPINGF0L7Qt9GP0LnRgdGC0LIg0L7RgiAzMDDQs9CwIn0sImF2YWlsYWJsZSI6dHJ1ZX0seyJ0eXBlIjoiYnV0dG9uIiwib3B0aW9ucyI6eyJiYWNrZ3JvdW5kQ29sb3IiOiIjRjlGQjA0IiwiY29udGVudCI6ItCj0LfQvdCw0YLRjCDQsdC-0LvRjNGI0LUiLCJjb2xvciI6IiMwRDBDMEMifSwiYXZhaWxhYmxlIjp0cnVlfSx7InR5cGUiOiJmYWRlIiwib3B0aW9ucyI6eyJjb2xvciI6IiMwMDAwMDAifSwiYXZhaWxhYmxlIjp0cnVlfSx7InR5cGUiOiJkZXNjcmlwdGlvbiIsIm1heExlbmd0aCI6NzUsIm9wdGlvbnMiOnsiY29sb3IiOiIjRkZGRkZGIiwiY29udGVudCI6ItCo0YLQsNC90LPQsCDQvtCx0YrQtdC80L3QvtC5INC60L7QvdGB0YLRgNGD0LrRhtC40LguINCU0LjQvtC00L3QsNGPINC_0L7QtNGB0LLQtdGC0LrQsC4g0J_QvtGA0L7RiNC60L7QstCw0Y8g0L_QvtC60YDQsNGB0LrQsC4gIn0sImF2YWlsYWJsZSI6dHJ1ZX0seyJ0eXBlIjoiZG9tYWluIiwib3B0aW9ucyI6eyJjb2xvciI6IiNGRkZGRkYiLCJjb250ZW50IjoiaHR0cHM6Ly9yb3N0bGluZS11Zy5ydS8ifSwiYXZhaWxhYmxlIjp0cnVlfSx7InR5cGUiOiJhZ2VSZXN0cmljdGlvbiIsIm9wdGlvbnMiOnsiY29sb3IiOiIjRkZGRkZGIiwiY29udGVudCI6IjE4IiwidmFsdWUiOiIxOCJ9LCJhdmFpbGFibGUiOnRydWV9XSwiaGVpZ2h0Ijo1MCwid2lkdGgiOjMyMCwiQVVDVElPTl9EQ19QQVJBTVMiOnsiY3JlYXRpdmVfcGFyYW1zIjp7ImNyeXB0YV91c2VyX2FnZSI6InVua25vd24iLCJjcnlwdGFfdXNlcl9nZW5kZXIiOiIxIn0sImRhdGFfcGFyYW1zIjp7IjcyMDU3NjA0Mzg0NDA4MDM5Ijp7Im9iamVjdF9pZCI6IkMxMTE3NTA4MDA4IiwidGFyZ2V0X3VybCI6Imh0dHA6Ly9ydS55YW5kZXgubWVkaWEtY3JlYXRpdmUiLCJ0ZXh0Ijp7ImRvbWFpbiI6InJvc3RsaW5lLXVnLnJ1IiwiY2xpZW50X2lkIjoiOTI0MTc2OTEiLCJsYW5nIjoiMSIsImRvbWFpblZlcmlmaWVkIjoiMCJ9LCJjb3VudCI6Imh0dHBzOi8vYW4ueWFuZGV4LnJ1L3Jlc291cmNlL3NwYWNlci5naWY_IiwiaXNUdXJib0Jhbm5lciI6ZmFsc2UsInVubW9kZXJhdGVkIjp7ImJhbm5lckZsYWdzIjoiIiwiZG9tYWluSWQiOiIyNDc4ODQ4NCIsInByb2R1Y3QiOiIiLCJhZElkIjoiNzIwNTc2MDQzODQ0MDgwMzkiLCJibWNhdGVnb3J5SWQiOiIyMDAwMDE1NDcifSwiY2xpY2tfdXJsIjp7ImltYWdlX29yaWciOiJodHRwczovL2FuLnlhbmRleC5ydS9jb3VudC9XemVlaklfek9DNDNYSHUwWDNIM0c4SXRZQ3gtaTBLMG1HR24tRDdkT0cwMDAwMHVualNRRzBZU3pVSXF4dWtHckNPMVcwN1pXWVU4MFZ0QXdUNWRhMDdFWHZRQnBPMjBXMEFPMFN3N2JlakRpMDdHbmp3ZjJCVzFaZTc5aUk3MDBHQk8wVEpNX1BTMXUwNnFnallOMFVXMWIwRnUwU29TWUZaSDV4YTJNR0d0ODdkdUo3Sm0wZ3hrc2VpQ1cwRmRkT2RqMHVXM2RVTWx4R1VlMHowRmtKX3UxOEFKMU9XNVdmQzVhME1mbDBNVzFPVjkwUVc1bmdTMWkwTjZmbTZ1MU9RbzBTMDVyaXlGbzBNb18wRkcxUlBHd2V3MXhtTVcxa0FpMFFXNnVlR0IzY1ZaMW9GdmdHVWVpejNqbHRCRF94Vzd5ZTMyVzgwNnUwWTRfRVdCeTBjMDFWVzlQODBBMUFXQWZFVVYyQ2FBSUM4a0VFSGJzMy1PMm5JZzJuMXBKN1BGZ0JDMDA4VHdmT2xoclVXQmdSb01lRHctMFFhQ2JNQkFhUV9aeWhfZTM5UzJjMHREcUtOVzNPQTBhTzZPVzBKbzNJR3RFSjFiUEo4b0RZcW9ESktxQkpHbkUzMGpPYzVZRDJyY09jQ3ZQTURaQ1piYUVRMEVtOEd6Z0VWb19lM090RVJfMFRhRmFMQzFONHRyckotMDRBZ2Zmbm9HNEQ2dWdPRU1rOVFlQ3c0WXExM2RmRmRfX3ZXSFdGNFRlSDVJazF3NXdyNzhpRVFoYVdaZjRkVVR5TEdhdTNQUXUxRTZpVzYwNTgyME85MEtYOVV1a0JSeW1QN3YwUTBLWGg4MWcxSWZsME4tb082RjFrMEswVVdLWjBCRzVWeDlXT3k2czFOMVlsUmlldS15XzZGbTVRb3F2QVliYWprQVpXNk81Z3h0WDh5NmVCME1pV0Y5NWowTWJnM1VsVzYxNXZXTmN6czhCQVdOMUMwTmpIQkc1ejI2MHpXTnBBTy13MVMxY0hZVzYxTW02RHM5ZHV5NmsxVzJxMVcyLTFaRG5lVm5pVnRYaW9BMDZPYVBQM2E3MDAwMDAwMkc2RzZXNlVBaTBSV1BxWGFJVU01WVNyenBQTjlzUE44bFNaT25DWXFudTFhMXcxYzBtV0ZtNk8zMjB1NFFfX3pfX2tsVm14RTg2aTI0RlBXUXJDREplMWhXaWtFV2tqMjhyWU1tNmxNNV9oQS1YUk5FVUM4UXFYZWFQTVBhRHM5Y1AzU2pPSkxiRFlxdU9NR3NCSlNxT2NLak9jR3ZEc1BjUFpPdURwT3Z6SGUxMDAwMGMxbERxS01tNnFZdTZtRmY2cHgxM3BnTDJHZjF5MWt5Y1pFMjcwcW5UWjR3UGN2QUU0clhLTFN0d0hvMDdWel9jSHRXN1B0ZW9HUWU3VzdHN2kzTlpQUnFwa2dpSWpXVS1qZVUtMXcwN202ODdfX19fbTZXN3dnZmZub203bUI4N3doaF9haWM4MTR1NDRDMDhTa0c1djFzdFE0dHY2S1dJR3dfWkRiNm43NzRZMVZianJhNktYbjdZMkNaWG5nSThiZTNYQ0NTelNpUzNpVTlDbTBXRnBab2w4U00yd0RnZ25jaHVTMmN4OEYweGJrUHJDM3lDT1VwN1ZkNUFHVmd2MkMzNHU3ZGtKRk9ZdzFfVXEta1BvbzY4bmNBSWRBNFVwUVJfeHB3OEYxQWJWOUZqZVd2SzhXSTNtMDB-MSIsImNsaWNrVXJsMSI6IiIsImNsaWNrVXJsMiI6IiIsImNsaWNrVXJsMyI6IiJ9fSwibWlzYyI6eyJ0cmFja2VycyI6WyIiXSwib2JqZWN0X2lkIjoiQzExMTc1MDgwMDgiLCJ0YXJnZXRfdXJsIjoiaHR0cDovL3J1LnlhbmRleC5tZWRpYS1jcmVhdGl2ZSIsImNsaWNrX3VybCI6eyJhYnVzZSI6Ii8vYW4ueWFuZGV4LnJ1L2FidXNlL1dEaWVqSV96OEZNTDFXMksycUQwWEJWRlg5TTExRzNyMDM3dXFVVFgwMDAwMDNaNnJuZm1kRk5hakUtQmFESjYwUDAxcGVVTVl5czBXODAyYzA3RVh2UUJKUlcxWmU3OWlJN08wVEpNX1BTMXcwNkswdzAyWUZaSDV1MDN2dnM5eEdFODB2dGJoLXE3b0dRNDJtdmR1bVNaLVFhN2dCRkd4UnpvcFZfRzFtQkcyODIwVzgwMlNxbnNKd1lwMDAyN1VnTUJ3eks1MEUwSzBUV0xtT2hzeEFFRmxGblpXSFVPNXZsVFkycHU2ODBQV1htRENOT25FY1BrSVpYRE9MNU5ELWFTVzFyXzFtMVQ4NVhNOUJZS3ZiQ1lRNGUwQmNLRVQwS0RDMGUwfjEifX19fX0sICJib2R5Iik7CiAgICAgICAgICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgICAgPC9ib2R5PgogICAgICAgIDwvaHRtbD4="}}';
        const answer = getRtbCacheAnswer(apphostContextMock, bsMeta, adaptedMeta, defaultQueryMock);

        expect(answer).toMatchSnapshot();
    });

    it('MediaCreative. no base64 encoded', () => {
        // rtb.data.dc_params.data_params
        const bsMeta = '{"rtb":{"data":{"dc_params":{"data_params":{}}}}}';
        const adaptedMeta = '{"rtb":{"html":"<!DOCTYPE html>\\n        <html lang=\\"en\\">\\n            <head>\\n                <meta charset=\\"UTF-8\\">\\n                <title>Title</title>\\n            </head>\\n            <body style=\\"margin:0;\\">\\n                \x3Cscript src=\\"https://yandex.ru/ads/system/media.js\\">\x3C/script>\\n                \x3Cscript>\\n                    window.Ya.mediaCode.create(\\n                        {\\"name\\":\\"media-banner_theme_speedy\\",\\"version\\":2},\\n                        {\\"mediaSets\\":{\\"uniq1\\":{\\"items\\":[{\\"items\\":[{\\"isDefault\\":false,\\"url\\":\\"https://avatars.mds.yandex.net/get-canvas/3568408/2a00000177b500edcbdbdcec61a2feff7d2c/cropSource\\",\\"alias\\":\\"normal\\",\\"fileId\\":\\"602e54de7a6fb20069727274\\",\\"croppedFileId\\":\\"602e56427a6fb200697272b6\\",\\"height\\":96,\\"width\\":636}],\\"type\\":\\"image\\"}]}},\\"options\\":{\\"borderColor\\":\\"#F41818\\",\\"backgroundColor\\":\\"#FDE900\\",\\"hasAnimation\\":true,\\"isAdaptive\\":false},\\"bundle\\":{\\"name\\":\\"media-banner_theme_speedy\\",\\"version\\":2},\\"elements\\":[{\\"type\\":\\"image\\",\\"mediaSet\\":\\"uniq1\\",\\"options\\":{\\"width\\":318,\\"height\\":48},\\"available\\":true},{\\"type\\":\\"headline\\",\\"maxLength\\":60,\\"options\\":{\\"color\\":\\"#FFFFFF\\",\\"content\\":\\"Ð\x9EÐ¿Ñ\x80Ñ\x8BÑ\x81ÐºÐ¸Ð²Ð°Ñ\x82ÐµÐ»Ñ\x8C Ð¢Ð¸Ñ\x82Ð°Ð½-3000-24.  Ð\x94Ð»Ñ\x8F Ñ\x85Ð¾Ð·Ñ\x8FÐ¹Ñ\x81Ñ\x82Ð² Ð¾Ñ\x82 300Ð³Ð°\\"},\\"available\\":true},{\\"type\\":\\"button\\",\\"options\\":{\\"backgroundColor\\":\\"#F9FB04\\",\\"content\\":\\"Ð£Ð·Ð½Ð°Ñ\x82Ñ\x8C Ð±Ð¾Ð»Ñ\x8CÑ\x88Ðµ\\",\\"color\\":\\"#0D0C0C\\"},\\"available\\":true},{\\"type\\":\\"fade\\",\\"options\\":{\\"color\\":\\"#000000\\"},\\"available\\":true},{\\"type\\":\\"description\\",\\"maxLength\\":75,\\"options\\":{\\"color\\":\\"#FFFFFF\\",\\"content\\":\\"Ð¨Ñ\x82Ð°Ð½Ð³Ð° Ð¾Ð±Ñ\x8AÐµÐ¼Ð½Ð¾Ð¹ ÐºÐ¾Ð½Ñ\x81Ñ\x82Ñ\x80Ñ\x83ÐºÑ\x86Ð¸Ð¸. Ð\x94Ð¸Ð¾Ð´Ð½Ð°Ñ\x8F Ð¿Ð¾Ð´Ñ\x81Ð²ÐµÑ\x82ÐºÐ°. Ð\x9FÐ¾Ñ\x80Ð¾Ñ\x88ÐºÐ¾Ð²Ð°Ñ\x8F Ð¿Ð¾ÐºÑ\x80Ð°Ñ\x81ÐºÐ°. \\"},\\"available\\":true},{\\"type\\":\\"domain\\",\\"options\\":{\\"color\\":\\"#FFFFFF\\",\\"content\\":\\"https://rostline-ug.ru/\\"},\\"available\\":true},{\\"type\\":\\"ageRestriction\\",\\"options\\":{\\"color\\":\\"#FFFFFF\\",\\"content\\":\\"18\\",\\"value\\":\\"18\\"},\\"available\\":true}],\\"height\\":50,\\"width\\":320,\\"AUCTION_DC_PARAMS\\":{\\"creative_params\\":{\\"crypta_user_age\\":\\"unknown\\",\\"crypta_user_gender\\":\\"1\\"},\\"data_params\\":{\\"72057604384408039\\":{\\"object_id\\":\\"C1117508008\\",\\"target_url\\":\\"http://ru.yandex.media-creative\\",\\"text\\":{\\"domain\\":\\"rostline-ug.ru\\",\\"client_id\\":\\"92417691\\",\\"lang\\":\\"1\\",\\"domainVerified\\":\\"0\\"},\\"count\\":\\"https://an.yandex.ru/resource/spacer.gif?\\",\\"isTurboBanner\\":false,\\"unmoderated\\":{\\"bannerFlags\\":\\"\\",\\"domainId\\":\\"24788484\\",\\"product\\":\\"\\",\\"adId\\":\\"72057604384408039\\",\\"bmcategoryId\\":\\"200001547\\"},\\"click_url\\":{\\"image_orig\\":\\"https://an.yandex.ru/count/WzeejI_zOC43XHu0X3H3G8ItYCx-i0K0mGGn-D7dOG00000unjSQG0YSzUIqxukGrCO1W07ZWYU80VtAwT5da07EXvQBpO20W0AO0Sw7bejDi07Gnjwf2BW1Ze79iI700GBO0TJM_PS1u06qgjYN0UW1b0Fu0SoSYFZH5xa2MGGt87duJ7Jm0gxkseiCW0FddOdj0uW3dUMlxGUe0z0FkJ_u18AJ1OW5WfC5a0Mfl0MW1OV90QW5ngS1i0N6fm6u1OQo0S05riyFo0Mo_0FG1RPGwew1xmMW1kAi0QW6ueGB3cVZ1oFvgGUeiz3jltBD_xW7ye32W806u0Y4_EWBy0c01VW9P80A1AWAfEUV2CaAIC8kEEHbs3-O2nIg2n1pJ7PFgBC008TwfOlhrUWBgRoMeDw-0QaCbMBAaQ_Zyh_e39S2c0tDqKNW3OA0aO6OW0Jo3IGtEJ1bPJ8oDYqoDJKqBJGnE30jOc5YD2rcOcCvPMDZCZbaEQ0Em8GzgEVo_e3OtER_0TaFaLC1N4trrJ-04AgffnoG4D6ugOEMk9QeCw4Yq13dfFd__vWHWF4TeH5Ik1w5wr78iEQhaWZf4dUTyLGau3PQu1E6iW605820O90KX9UukBRymP7v0Q0KXh81g1Ifl0N-oO6F1k0K0UWKZ0BG5Vx9WOy6s1N1YlRieu-y_6Fm5QoqvAYbajkAZW6O5gxtX8y6eB0MiWF95j0Mbg3UlW615vWNczs8BAWN1C0NjHBG5z260zWNpAO-w1S1cHYW61Mm6Ds9duy6k1W2q1W2-1ZDneVniVtXioA06OaPP3a70000002G6G6W6UAi0RWPqXaIUM5YSrzpPN9sPN8lSZOnCYqnu1a1w1c0mWFm6O320u4Q__z__klVmxE86i24FPWQrCDJe1hWikEWkj28rYMm6lM5_hA-XRNEUC8QqXeaPMPaDs9cP3SjOJLbDYquOMGsBJSqOcKjOcGvDsPcPZOuDpOvzHe10000c1lDqKMm6qYu6mFf6px13pgL2Gf1y1kycZE270qnTZ4wPcvAE4rXKLStwHo07Vz_cHtW7PteoGQe7W7G7i3NZPRqpkgiIjWU-jeU-1w07m687____m6W7wgffnom7mB87whh_aic814u44C08SkG5v1stQ4tv6KWIGw_ZDb6n774Y1Vbjra6KXn7Y2CZXngI8be3XCCSzSiS3iU9Cm0WFpZol8SM2wDggnchuS2cx8F0xbkPrC3yCOUp7Vd5AGVgv2C34u7dkJFOYw1_Uq-kPoo68ncAIdA4UpQR_xpw8F1AbV9FjeWvK8WI3m00~1\\",\\"clickUrl1\\":\\"\\",\\"clickUrl2\\":\\"\\",\\"clickUrl3\\":\\"\\"}},\\"misc\\":{\\"trackers\\":[\\"\\"],\\"object_id\\":\\"C1117508008\\",\\"target_url\\":\\"http://ru.yandex.media-creative\\",\\"click_url\\":{\\"abuse\\":\\"//an.yandex.ru/abuse/WDiejI_z8FML1W2K2qD0XBVFX9M11G3r037uqUTX000003Z6rnfmdFNajE-BaDJ60P01peUMYys0W802c07EXvQBJRW1Ze79iI7O0TJM_PS1w06K0w02YFZH5u03vvs9xGE80vtbh-q7oGQ42mvdumSZ-Qa7gBFGxRzopV_G1mBG2820W802SqnsJwYp0027UgMBwzK50E0K0TWLmOhsxAEFlFnZWHUO5vlTY2pu680PWXmDCNOnEcPkIZXDOL5ND-aSW1r_1m1T85XM9BYKvbCYQ4e0BcKET0KDC0e0~1\\"}}}}}, \\"body\\");\\n                \x3C/script>\\n            </body>\\n        </html>"}}';
        const answer = getRtbCacheAnswer(apphostContextMock, bsMeta, adaptedMeta, defaultQueryMock);

        expect(answer).toMatchSnapshot();
    });
});
